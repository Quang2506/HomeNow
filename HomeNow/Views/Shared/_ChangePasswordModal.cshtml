@using Core.Resources

<style>
    /* ✅ Scope riêng, không đè CSS popup khác */
    #changePwOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.55);
        z-index: 10001;
        justify-content: center;
        align-items: center;
    }

        #changePwOverlay #changePwBox {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            width: 350px;
            max-width: 92%;
            position: relative;
            box-sizing: border-box;
        }

        #changePwOverlay #changePwClose {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        #changePwOverlay #changePwBox h3 {
            margin: 0 0 10px 0;
            font-weight: 900;
        }

        #changePwOverlay #changePwBox input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        #changePwOverlay .cp-actions {
            display: flex;
            gap: 10px;
        }

            #changePwOverlay .cp-actions button {
                width: 50%;
                padding: 10px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 800;
            }

        #changePwOverlay #btnChangePwCancel {
            background: #e2e8f0;
            color: #0f172a;
        }

            #changePwOverlay #btnChangePwCancel:hover {
                background: #cbd5e1;
            }

        #changePwOverlay #btnChangePwSave {
            background: #0f172a;
            color: #fff;
        }

            #changePwOverlay #btnChangePwSave:hover {
                background: #1e293b;
            }

        #changePwOverlay #changePwMsg {
            font-size: 13px;
            font-weight: 700;
            margin: 8px 0 10px;
            display: none;
        }

            #changePwOverlay #changePwMsg.ok {
                color: #16a34a;
            }

            #changePwOverlay #changePwMsg.err {
                color: #ef4444;
            }
</style>

<div id="changePwOverlay">
    <div id="changePwBox">
        <span id="changePwClose">&times;</span>
        <h3>Thay đổi mật khẩu</h3>

        <div id="changePwMsg"></div>

        <input type="password" id="cpOldPass" placeholder="Mật khẩu cũ" />
        <input type="password" id="cpNewPass" placeholder="Mật khẩu mới" />
        <input type="password" id="cpConfirmPass" placeholder="Xác nhận mật khẩu mới" />

        <div class="cp-actions">
            <button type="button" id="btnChangePwCancel">Hủy</button>
            <button type="button" id="btnChangePwSave">Cập nhật</button>
        </div>
    </div>
</div>

<script>
    (function () {
        //  giữ logic cũ: vẫn có window.changePasswordModal, vẫn mở bằng .js-open-change-password
        function showMsg(text, ok) {
            var $el = $("#changePwMsg");
            $el.removeClass("ok err").addClass(ok ? "ok" : "err").text(text).show();
        }

        function openChangePw() {
            $("#changePwMsg").hide();
            $("#cpOldPass,#cpNewPass,#cpConfirmPass").val("");
            $("#changePwOverlay").css("display", "flex");
        }

        function closeChangePw() {
            $("#changePwOverlay").hide();
        }

        window.changePasswordModal = {
            open: openChangePw,
            close: closeChangePw
        };

        // click class này sẽ mở popup (GIỮ NGUYÊN logic bạn đang dùng)
        $(document).on("click", ".js-open-change-password", function (e) {
            e.preventDefault();
            openChangePw();
        });

        $("#changePwClose").on("click", closeChangePw);
        $("#btnChangePwCancel").on("click", closeChangePw);

        $("#btnChangePwSave").on("click", function () {
            var oldPass = $("#cpOldPass").val();
            var newPass = $("#cpNewPass").val();
            var cfPass  = $("#cpConfirmPass").val();

            $("#changePwMsg").hide();

            if (!oldPass || !newPass || !cfPass) {
                showMsg("Vui lòng nhập đầy đủ thông tin.", false);
                return;
            }
            if (newPass !== cfPass) {
                showMsg("Xác nhận mật khẩu mới không khớp.", false);
                return;
            }

            $.post("@Url.Action("ChangePasswordAjax","Account")", {
                oldPassword: oldPass,
                newPassword: newPass,
                confirmPassword: cfPass
            }, function (res) {
                if (res && res.success) {
                    showMsg(res.message || "Đổi mật khẩu thành công.", true);
                    setTimeout(closeChangePw, 500);
                    return;
                }
                showMsg((res && res.message) ? res.message : "Đổi mật khẩu thất bại.", false);
            });
        });

        // (tùy chọn) click nền để đóng - không ảnh hưởng logic cũ
        $("#changePwOverlay").on("click", function (e) {
            if (e.target === this) closeChangePw();
        });
    })();
</script>
