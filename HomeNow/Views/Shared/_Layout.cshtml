@using Core.Resources
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - NhàNow</title>
    @Styles.Render("~/Content/css")
    <link rel="stylesheet" href="~/Content/font-awesome/all.min.css" />
    @Scripts.Render("~/bundles/modernizr")
    @RenderSection("Styles", required: false)
    <style>
        body {
            margin: 0px !important;
        }

        #loginOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #loginBox {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 350px;
            max-width: 90%;
            position: relative;
        }

            #loginBox h3 {
                margin-bottom: 10px;
            }

            #loginBox input {
                width: 93%;
                padding: 10px;
                margin-bottom: 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }

            #loginBox button {
                width: 100%;
                padding: 10px;
                border: none;
                background: #0f172a;
                color: #fff;
                border-radius: 6px;
                cursor: pointer;
            }

                #loginBox button:hover {
                    background: #1e293b;
                }

        #closeLogin {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

            #closeLogin:hover {
                color: #000;
            }

        #switchToRegister {
            display: block;
            margin-top: 10px;
            text-align: center;
            color: #0f172a;
            cursor: pointer;
        }

        /* ===== OTP overlay ===== */
        #otpOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.55);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        #otpBox {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            width: 350px;
            max-width: 92%;
            position: relative;
        }

            #otpBox h3 {
                margin: 0 0 10px 0;
                font-weight: 900;
            }

            #otpBox .otp-row {
                display: flex;
                gap: 10px;
            }

                #otpBox .otp-row button {
                    width: auto;
                    flex: 0 0 auto;
                    padding: 10px 12px;
                }

        #otpClose {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        /* ===== Forgot overlay ===== */
        #forgotOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.55);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        #forgotBox {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            width: 350px;
            max-width: 92%;
            position: relative;
        }

        #forgotClose {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        .tiny-link {
            font-size: 12px;
            color: #0f172a;
            cursor: pointer;
            text-decoration: underline;
        }

        .msg {
            font-size: 13px;
            font-weight: 700;
            margin: 8px 0;
        }

            .msg.ok {
                color: #16a34a;
            }

            .msg.err {
                color: #ef4444;
            }
    </style>
</head>

<body>
    <div class="container body-content">
        @RenderSection("PageHeader", required: false)
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - NhàNow</p>
        </footer>
    </div>

    <!-- ===== Login/Register Overlay ===== -->
    <div id="loginOverlay">
        <div id="loginBox">
            <span id="closeLogin">&times;</span>

            <!-- Login Form -->
            <div id="loginForm">
                <h3>@AuthTexts.Login_Title</h3>
                <input type="text" id="loginName" placeholder="@AuthTexts.Login_EmailOrPhone" />
                <input type="password" id="loginPassword" placeholder="@AuthTexts.Login_Password" />
                <button id="btnLogin">@AuthTexts.Login_Button</button>

                <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span class="tiny-link" id="openForgot">@AuthTexts.Login_Forgot</span>
                    <span id="switchToRegister">@AuthTexts.Register_Title</span>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
                <h3>@AuthTexts.Register_Title</h3>
                <input type="text" id="regEmail" placeholder="@AuthTexts.Register_Email" />
                <input type="text" id="regPhone" placeholder="@AuthTexts.Register_Phone" />
                <input type="text" id="regDisplayName" placeholder="@AuthTexts.Register_DisplayName" />
                <input type="password" id="regPassword" placeholder="@AuthTexts.Register_Password" />
                <input type="password" id="regConfirmPassword" placeholder="@AuthTexts.Register_ConfirmPassword" />
                <button id="btnRegister">@AuthTexts.Register_Button</button>

                <span id="switchToLogin" style="display:block;margin-top:10px;text-align:center;color:#0f172a;cursor:pointer;">
                    @AuthTexts.Login_Title
                </span>
            </div>
        </div>
    </div>

    <!-- ===== OTP Overlay ===== -->
    <div id="otpOverlay">
        <div id="otpBox">
            <span id="otpClose">&times;</span>
            <h3>@AuthTexts.Otp_Title</h3>

            <div class="msg" id="otpMsg" style="display:none;"></div>

            <input type="text" id="otpEmail" readonly />
            <div class="otp-row">
                <input type="text" id="otpCode" placeholder="@AuthTexts.Otp_Code" style="margin-bottom:0;" />
                <button id="btnOtpVerify">@AuthTexts.Otp_VerifyButton</button>
            </div>

            <div style="margin-top:10px; display:flex; justify-content:space-between;">
                <span class="tiny-link" id="btnOtpResend">@AuthTexts.Otp_Resend</span>
            </div>
        </div>
    </div>

    <!-- ===== Forgot Overlay ===== -->
    <div id="forgotOverlay">
        <div id="forgotBox">
            <span id="forgotClose">&times;</span>
            <h3>@AuthTexts.Forgot_Title</h3>

            <div class="msg" id="forgotMsg" style="display:none;"></div>

            <input type="text" id="fgEmail" placeholder="@AuthTexts.Forgot_Email" />
            <button id="btnSendResetOtp">@AuthTexts.Forgot_SendOtp</button>

            <hr />

            <input type="text" id="fgCode" placeholder="@AuthTexts.Otp_Code" />
            <input type="password" id="fgNewPass" placeholder="@AuthTexts.Forgot_NewPassword" />
            <input type="password" id="fgConfirmPass" placeholder="@AuthTexts.Forgot_ConfirmNewPassword" />
            <button id="btnResetPass">@AuthTexts.Forgot_ResetButton</button>
        </div>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")

    <!--  ChangePasswordModal  -->
    @Html.Partial("~/Views/Shared/_ChangePasswordModal.cshtml")
    @Html.Partial("~/Views/Shared/_ProfilePopup.cshtml")


    <script>
        // ========= helpers =========
        function showMsg($el, text, ok) {
            $el.removeClass('ok err');
            $el.addClass(ok ? 'ok' : 'err');
            $el.text(text).show();
        }

        // expose loginModal cho các trang khác gọi (favorites popup đang dùng)
        window.loginModal = {
            open: function () {
                $("#loginOverlay").css("display", "flex");
                $("#loginForm").show();
                $("#registerForm").hide();
            },
            close: function () { $("#loginOverlay").hide(); }
        };

        // ===== Open login by class trigger .js-open-login =====
        $(document).on("click", ".js-open-login", function (e) {
            e.preventDefault();
            window.loginModal.open();
        });

        // Close login
        $("#closeLogin").click(function () {
            $("#loginOverlay").hide();
        });

        // Switch forms
        $("#switchToRegister").click(function () {
            $("#loginForm").hide();
            $("#registerForm").show();
        });

        $("#switchToLogin").click(function () {
            $("#registerForm").hide();
            $("#loginForm").show();
        });

        // ===== OTP overlay open/close =====
        function openOtp(email, msg) {
            $("#otpEmail").val(email || "");
            $("#otpCode").val("");
            $("#otpMsg").hide();

            if (msg) showMsg($("#otpMsg"), msg, true);

            $("#otpOverlay").css("display", "flex");
        }
        function closeOtp() { $("#otpOverlay").hide(); }

        $("#otpClose").click(closeOtp);

        // ===== Forgot overlay open/close =====
        $("#openForgot").click(function () {
            $("#forgotMsg").hide();
            $("#forgotOverlay").css("display", "flex");
        });
        $("#forgotClose").click(function () { $("#forgotOverlay").hide(); });

        // ===== Login Ajax =====
        $("#btnLogin").click(function () {
            $.post("@Url.Action("LoginAjax","Account")", {
                loginName: $("#loginName").val(),
                password: $("#loginPassword").val()
            }, function (res) {
                if (res && res.success) {
                    location.reload();
                    return;
                }

                if (res && res.needVerify) {
                    $("#loginOverlay").hide();
                    openOtp(res.email, res.message);
                    return;
                }

                alert((res && res.message) ? res.message : "@AuthTexts.Msg_InvalidCredentials");
            });
        });

        // ===== Register Ajax =====
        $("#btnRegister").click(function () {
            $.post("@Url.Action("RegisterAjax","Account")", {
                email: $("#regEmail").val(),
                phoneNumber: $("#regPhone").val(),
                displayName: $("#regDisplayName").val(),
                password: $("#regPassword").val(),
                confirmPassword: $("#regConfirmPassword").val()
            }, function (res) {
                if (!res) { alert("Error"); return; }

                if (res.success && res.needVerify) {
                    $("#loginOverlay").hide();
                    openOtp(res.email, res.message);
                    return;
                }

                alert(res.message || "Register failed");
            });
        });

        // ===== OTP Verify =====
        $("#btnOtpVerify").click(function () {
            $.post("@Url.Action("VerifyEmailOtpAjax","Account")", {
                email: $("#otpEmail").val(),
                code: $("#otpCode").val()
            }, function (res) {
                if (res && res.success) {
                    closeOtp();
                    location.reload();
                    return;
                }
                showMsg($("#otpMsg"), (res && res.message) ? res.message : "Verify failed", false);
            });
        });

        // ===== OTP Resend =====
        $("#btnOtpResend").click(function () {
            $.post("@Url.Action("ResendVerifyOtpAjax","Account")", {
                email: $("#otpEmail").val()
            }, function (res) {
                if (res && res.success) {
                    showMsg($("#otpMsg"), res.message || "@AuthTexts.Msg_OtpResent", true);
                    return;
                }
                showMsg($("#otpMsg"), (res && res.message) ? res.message : "Resend failed", false);
            });
        });

        // ===== Forgot send OTP =====
        $("#btnSendResetOtp").click(function () {
            $.post("@Url.Action("SendResetOtpAjax","Account")", {
                email: $("#fgEmail").val()
            }, function (res) {
                if (res && res.success) {
                    showMsg($("#forgotMsg"), res.message || "@AuthTexts.Msg_OtpSent", true);
                    return;
                }
                showMsg($("#forgotMsg"), (res && res.message) ? res.message : "Send failed", false);
            });
        });

        // ===== Reset password =====
        $("#btnResetPass").click(function () {
            $.post("@Url.Action("ResetPasswordByOtpAjax","Account")", {
                email: $("#fgEmail").val(),
                code: $("#fgCode").val(),
                newPassword: $("#fgNewPass").val(),
                confirmPassword: $("#fgConfirmPass").val()
            }, function (res) {
                if (res && res.success) {
                    showMsg($("#forgotMsg"), res.message || "@AuthTexts.Msg_ResetSuccess", true);
                    return;
                }
                showMsg($("#forgotMsg"), (res && res.message) ? res.message : "Reset failed", false);
            });
        });
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>
