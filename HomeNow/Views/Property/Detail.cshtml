@using HomeNow.Resources
@using System.Web
@using System.Linq
@using System.Collections.Generic
@using Core.ViewModels
@using Core.Models
@using Core.Helpers

@model Core.ViewModels.PropertyDetailViewModel

@{
    Func<string, string, string> R = (key, fallback) =>
    {
        var s = HomeTexts.ResourceManager.GetString(key, System.Threading.Thread.CurrentThread.CurrentUICulture);
        return string.IsNullOrWhiteSpace(s) ? fallback : s;
    };

    ViewBag.Title = Model?.Title ?? R("Detail_Title", "Chi tiết");
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Header dùng chung sẽ đọc ViewBag.HeaderCityName
    ViewBag.HeaderCityName = !string.IsNullOrWhiteSpace(Model?.CityName) ? Model.CityName : HomeTexts.CityName;

    var JS_FavNeedLogin = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_NeedLogin);
    var JS_FavUpdateFail = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_UpdateFailed);

    var mapQuery = (Model?.AddressLine ?? "") + (string.IsNullOrWhiteSpace(Model?.CityName) ? "" : (", " + Model.CityName));
    var mapOpenUrl = "https://www.google.com/maps/search/?api=1&query=" + HttpUtility.UrlEncode(mapQuery ?? "");
}

<link rel="stylesheet" href="~/Content/font-awesome/all.min.css" />
<link rel="stylesheet" href="~/Content/style/Home/index.css" />

@section PageHeader{
    @Html.Partial("~/Views/Shared/_TopHeaderBar.cshtml", (Core.ViewModels.HeaderBarViewModel)null)
}

@section Styles{
    <style>
        .home-hero-header {
            margin-bottom: 0px !important;
        }

        .detail-wrap {
            max-width: 1200px;
            margin: 18px auto 24px;
            padding: 0 16px;
        }

        .detail-title {
            margin: 18px 0 14px;
            font-size: 25px;
            font-weight: 700;
            text-align: start;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.55fr .9fr;
            gap: 18px;
            align-items: start;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
            border: 1px solid rgba(15,23,42,.08);
        }

        .section-title {
            margin: 0 0 10px;
            font-size: 16px;
            font-weight: 900;
        }

        .preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            display: block;
        }

            .preview img {
                width: 100%;
                height: 380px;
                object-fit: cover;
                display: block;
                background: #f3f4f6;
            }

        .badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(16,185,129,.95);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 12px;
            z-index: 3;
        }

        .play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.35));
            z-index: 2;
        }

            .play .btn {
                width: 64px;
                height: 64px;
                border-radius: 999px;
                background: rgba(15,23,42,.85);
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 10px 24px rgba(0,0,0,.25);
            }

                .play .btn span {
                    color: #fff;
                    font-weight: 900;
                    font-size: 12px;
                    letter-spacing: .6px;
                }

        .hint {
            margin-top: 10px;
            color: #64748b;
            font-size: 13px;
        }

        .danger {
            color: #ef4444;
        }

        .right {
            position: sticky;
            top: 16px;
        }

        .detail-price-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .detail-price-line {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

            .detail-price-line i {
                color: #16a34a;
                font-size: 14px;
                opacity: .95;
            }

        .detail-price-text {
            color: #16a34a;
            font-weight: 900;
            font-size: 18px;
            line-height: 1.1;
            white-space: nowrap;
        }

        .detail-fav-btn.js-fav-toggle {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: none !important;
            outline: none;
            cursor: pointer;
            background: rgba(15, 23, 42, .08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
        }

            .detail-fav-btn.js-fav-toggle i {
                color: #64748b !important;
                font-size: 14px;
            }

            .detail-fav-btn.js-fav-toggle.is-fav {
                background: #ef4444 !important;
            }

                .detail-fav-btn.js-fav-toggle.is-fav i {
                    color: #fff !important;
                }

        .meta {
            margin-top: 8px;
            color: #475569;
        }

        .addr {
            margin-top: 6px;
            color: #475569;
            line-height: 1.5;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 18px;
        }

        .mobile-summary {
            display: none;
        }

        .desc-card {
            grid-column: auto;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 6px 10px;
            border-radius: 999px;
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 800;
            font-size: 12px;
            border: 1px solid rgba(15,23,42,.08);
        }

        .muted {
            color: #64748b;
        }

        .map-wrap {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(15,23,42,.08);
        }

            .map-wrap iframe {
                width: 100%;
                height: 280px;
                border: 0;
                display: block;
            }

        .map-open {
            position: absolute;
            right: 10px;
            top: 10px;
            background: rgba(15,23,42,.85);
            color: #fff;
            text-decoration: none;
            padding: 8px 10px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

            .map-open:hover {
                opacity: .95;
            }

        .similar-scroll {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc((100% - 18px * 2) / 3);
            gap: 18px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-gutter: stable both-edges;
            align-items: stretch;
        }

            .similar-scroll .property-card {
                scroll-snap-align: start;
                min-width: 0;
                height: 100%;
            }

        .property-card {
            position: relative;
            cursor: pointer;
        }

            .property-card a.card-link {
                color: inherit;
                text-decoration: none;
                display: block;
            }

            .property-card img {
                width: 100%;
                height: 160px;
                object-fit: cover;
                display: block;
                background: #f3f4f6;
                border-radius: 12px 12px 0 0;
            }

        .property-card-body {
            padding: 10px 12px 12px;
        }

        .property-card-title {
            font-weight: 900;
            line-height: 1.25;
            max-height: 2.5em;
            overflow: hidden;
        }

        .property-card-address {
            color: #64748b;
            font-size: 13px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-card-meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 6px;
            color: #334155;
            font-size: 13px;
        }

        .property-card-price {
            margin-top: 8px;
            font-weight: 900;
        }

        .property-card-fav {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: rgba(15,23,42,.65);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3;
        }

            .property-card-fav i {
                font-size: 14px;
                color: #fff;
            }

            .property-card-fav.is-fav {
                background: #ef4444;
            }

        .similar-scroll .property-card a.card-link {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .similar-scroll .property-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .similar-scroll .property-card-price {
            margin-top: auto;
        }

        @@media (max-width: 992px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .right {
                display: none;
            }

            .preview img {
                height: 260px;
            }

            .mobile-summary {
                display: block;
            }

            .desc-card {
                grid-column: 1 / -1;
            }

            .similar-scroll {
                grid-auto-columns: calc((100% - 16px) / 2);
                gap: 16px;
            }
        }

        @@media (max-width: 500px) {
            .detail-wrap {
                padding: 0 4px;
            }

            .detail-price-text {
                font-size: 15px;
            }

            .property-card-price {
                font-size: .7rem !important;
            }

            .similar-scroll {
                grid-auto-columns: calc((100% - 12px) / 2);
                gap: 12px;
            }
        }
    </style>
}

<div class="detail-wrap">
    <h1 class="detail-title">@Model.Title</h1>

    <div class="detail-grid">
        <!-- LEFT -->
        <div>
            <div class="card">
                @if (Model.IsVrAvailable)
                {
                    <a class="preview" href="@Url.Action("Vr","Property", new { id = Model.PropertyId })" style="text-decoration:none;">
                        <span class="badge">VR 360°</span>
                        <img src="@Model.CoverImageUrl" alt="@Model.Title" loading="lazy" decoding="async" />
                        <div class="play"><div class="btn"><span>PLAY</span></div></div>
                    </a>
                    <div class="hint">@R("Detail_ClickToVr", "Click ảnh để vào màn VR")</div>
                }
                else
                {
                    <div class="preview">
                        <img src="@Model.CoverImageUrl" alt="@Model.Title" loading="lazy" decoding="async" />
                    </div>
                    <div class="hint danger">@R("Detail_NoVr", "Nhà này chưa có VR.")</div>
                }
            </div>

            <!-- Mobile: Summary + Amenities -->
            <div class="two-col">
                <div class="card mobile-summary">
                    <div class="detail-price-row">
                        <div class="detail-price-line">
                            <i class="fa-solid fa-sack-dollar"></i>
                            <!-- ✅ GIÁ GIỐNG HOME/LIST -->
                            <span class="detail-price-text">@MoneyText.ToPriceShort(Model.Price, Model.ListingType)</span>
                        </div>

                        <!--  Favorites (ô đỏ) -->
                        <button type="button"
                                class="detail-fav-btn js-fav-toggle"
                                data-id="@Model.PropertyId"
                                title="@R("Favorite_Title","Yêu thích")">
                            <i class="fa-solid fa-heart"></i>
                        </button>
                    </div>

                    <div class="meta">@Model.Area m² · @(Model.BedroomCount ?? 0) PN · @(Model.BathroomCount ?? 0) WC</div>
                    <div class="addr">
                        @Model.AddressLine
                        @if (!string.IsNullOrWhiteSpace(Model.CityName))
                        {@Model.CityName}
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">@R("Detail_Amenities", "Tiện ích / Nội thất")</h3>
                    @if (Model.Amenities == null || !Model.Amenities.Any())
                    {
                        <div class="muted">@R("Common_NotUpdated", "Chưa cập nhật.")</div>
                    }
                    else
                    {
                        <div class="tags">
                            @foreach (var a in Model.Amenities)
                            {
                                <span class="tag">@a</span>
                            }
                        </div>
                    }
                </div>

                <div class="card desc-card">
                    <h3 class="section-title">@R("Detail_Description", "Mô tả")</h3>
                    <div style="color:#334155; line-height:1.7;">
                        @Html.Raw((Model.Description ?? "").Replace("\n", "<br/>"))
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="card" style="margin-top:18px;">
                <h3 class="section-title">@R("Detail_MapTitle", "Vị trí trên bản đồ")</h3>

                @if (!string.IsNullOrWhiteSpace(Model.MapEmbedUrl))
                {
                    <div class="map-wrap">
                        <a class="map-open" href="@mapOpenUrl" target="_blank" rel="noopener">
                            <i class="fa-solid fa-diamond-turn-right"></i> @R("Detail_Directions", "Chỉ đường")
                        </a>
                        <iframe src="@Model.MapEmbedUrl" loading="lazy"></iframe>
                    </div>
                }
                else
                {
                    <div class="muted">@R("Detail_NoMap", "Chưa có dữ liệu bản đồ.")</div>
                }
            </div>

            <!-- Similar -->
            <div class="card detail-similar" style="margin-top:18px;">
                <h3 class="section-title">@R("Detail_Similar", "Căn hộ tương tự")</h3>

                @if (Model.Similar == null || !Model.Similar.Any())
                {
                    <div class="muted">@R("Common_NoData", "Chưa có dữ liệu.")</div>
                }
                else
                {
                    <div class="similar-scroll">
                        @foreach (var s in (Model.Similar ?? new List<PropertyListItemViewModel>()).Take(4))
                        {
                            <div class="property-card">
                                <div class="property-card-fav js-fav-toggle @(s.IsFavorite ? "is-fav" : "")"
                                     data-id="@s.PropertyId"
                                     title="@R("Favorite_Title","Yêu thích")">
                                    <i class="fa-solid fa-heart"></i>
                                </div>

                                <a class="card-link" href="@Url.Action("Detail","Property", new { id = s.PropertyId })">
                                    <img src="@s.ThumbnailUrl" alt="@s.Title" loading="lazy" decoding="async" />
                                    <div class="property-card-body">
                                        <div class="property-card-title">@s.Title</div>
                                        <div class="property-card-address">
                                            <i class="fa-solid fa-location-dot"></i> @s.Address
                                        </div>
                                        <div class="property-card-meta">
                                            <span><i class="fa-solid fa-bed"></i> @(s.Bed ?? 0) PN <i class="fa-solid fa-bath"></i> @(s.Bath ?? 0) WC</span>
                                            <span><i class="fa-solid fa-ruler-combined"></i> @s.Area m²</span>
                                        </div>
                                        <div class="property-card-price">
                                            <!-- ✅ GIÁ GIỐNG HOME/LIST -->
                                            <i class="fa-solid fa-sack-dollar"></i> @MoneyText.ToPriceShort(s.Price, s.ListingType)
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT (desktop only) -->
        <aside class="card right">
            <div class="detail-price-row">
                <div class="detail-price-line">
                    <i class="fa-solid fa-sack-dollar"></i>
                    <!-- ✅ GIÁ GIỐNG HOME/LIST -->
                    <span class="detail-price-text">@MoneyText.ToPriceShort(Model.Price, Model.ListingType)</span>
                </div>

                <button type="button"
                        class="detail-fav-btn js-fav-toggle"
                        data-id="@Model.PropertyId"
                        title="@R("Favorite_Title","Yêu thích")">
                    <i class="fa-solid fa-heart"></i>
                </button>
            </div>

            <div class="meta">@Model.Area m² · @(Model.BedroomCount ?? 0) PN · @(Model.BathroomCount ?? 0) WC</div>
            <div class="addr">
                @Model.AddressLine
                @if (!string.IsNullOrWhiteSpace(Model.CityName))
                {@Model.CityName}
            </div>
        </aside>
    </div>
</div>

@section Scripts{
    <script>
        // Apply fav state on load (reload không bị mất tim đỏ)
        (function () {
            function applyFavIds(ids) {
                ids = ids || [];
                var set = {};
                for (var i = 0; i < ids.length; i++) set[String(ids[i])] = true;

                $('.js-fav-toggle').each(function () {
                    var pid = $(this).data('id');
                    $(this).toggleClass('is-fav', !!set[String(pid)]);
                });
            }

            // ưu tiên dùng hàm header (nếu có)
            if (typeof window.refreshHeaderFav === 'function') {
                window.refreshHeaderFav().always(function () {
                    applyFavIds(window.__favIds || []);
                });
                return;
            }

            // fallback: tự gọi HeaderFavoriteInfo
            $.get('@Url.Action("HeaderFavoriteInfo", "Property")')
                .done(function (res) {
                    if (!res) return;
                    window.__isAuth = !!res.isAuth;
                    window.__favIds = res.favoriteIds || [];
                    applyFavIds(window.__favIds);
                });
        })();

        // Toggle favorite (dùng chung)
        (function () {
            var MSG_NEED_LOGIN = '@JS_FavNeedLogin';
            var MSG_UPDATE_FAIL = '@JS_FavUpdateFail';

            function setFavState(propertyId, isFav) {
                // Đồng bộ tất cả nút tim có cùng data-id (desktop + mobile + similar nếu trùng)
                $('.js-fav-toggle').each(function () {
                    var pid = $(this).data('id');
                    if (String(pid) === String(propertyId)) {
                        $(this).toggleClass('is-fav', !!isFav);
                    }
                });
            }

            $(document).on('click', '.js-fav-toggle', function (e) {
                e.preventDefault();
                e.stopPropagation();

                var propertyId = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("ToggleFavorite", "Property")',
                    type: 'POST',
                    data: { propertyId: propertyId },
                    success: function (res) {
                        if (!res) return;

                        if (res.needLogin) {
                            if (window.loginModal && typeof window.loginModal.open === 'function') {
                                window.loginModal.open(window.location.pathname + window.location.search);
                            } else {
                                alert(MSG_NEED_LOGIN);
                            }
                            return;
                        }

                        if (res.success) {
                            setFavState(propertyId, !!res.isFavorite);

                            // update header badge + favIds
                            if (typeof window.refreshHeaderFav === 'function') {
                                window.refreshHeaderFav();
                            }

                            window.__isAuth = true;
                        }
                    },
                    error: function () {
                        alert(MSG_UPDATE_FAIL);
                    }
                });
            });
        })();
    </script>
}
