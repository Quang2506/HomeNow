@using HomeNow.Resources
@using System.Web
@using System.Linq
@using System.Collections.Generic
@using Core.ViewModels
@using Core.Models

@model Core.ViewModels.PropertyDetailViewModel

@{
    ViewBag.Title = Model?.Title ?? "Chi tiết";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var currentLang = System.Threading.Thread.CurrentThread.CurrentUICulture.Name;

    var favCount = (int)(ViewBag.FavoriteCount ?? 0);
    var favCountText = favCount > 99 ? "99+" : favCount.ToString();

    var headerCityName = !string.IsNullOrWhiteSpace(Model?.CityName) ? Model.CityName : HomeTexts.CityName;

    var JS_FavNeedLogin = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_NeedLogin);
    var JS_FavUpdateFail = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_UpdateFailed);

    var mapQuery = (Model?.AddressLine ?? "") + (string.IsNullOrWhiteSpace(Model?.CityName) ? "" : (", " + Model.CityName));
    var mapOpenUrl = "https://www.google.com/maps/search/?api=1&query=" + HttpUtility.UrlEncode(mapQuery ?? "");
}

<link rel="stylesheet" href="~/Content/font-awesome/all.min.css" />
<link rel="stylesheet" href="~/Content/style/Home/index.css" />

@section Styles{
    <style>
        /* ===================== HEADER (giống List) ===================== */
        .home-hero {
            background: none !important;
        }

            .home-hero.list-hero.detail-hero {
                position: relative;
                background-size: cover;
                background-position: center;
                padding: 7px 0 3px;
                border-radius: 0;
                margin: 0;
                height: auto !important;
                min-height: 0 !important;
            }

                .home-hero.list-hero.detail-hero::before {
                    content: "";
                    position: absolute;
                    inset: 0;
                    background: rgba(0,0,0,.45);
                }

                .home-hero.list-hero.detail-hero .home-hero-shell {
                    position: relative;
                    z-index: 1;
                    width: 97%;
                    margin: 0 auto;
                    padding: 0 !important;
                }

        .home-hero-header {
            margin: 0 !important;
        }

        .home-header-right-top a {
            margin: 0;
        }

        .account-hover {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding-bottom: 14px;
            z-index: 99999;
        }

        .account-trigger {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            color: #fff;
            border-radius: 999px;
            background: rgba(15,23,42,0);
            border: 0;
            outline: 0;
        }

            .account-trigger:hover {
                background: rgba(15,23,42,.55);
            }

        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            min-width: 160px;
            background: rgba(15,23,42,.95);
            border-radius: 12px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: opacity .15s ease, transform .15s ease;
            box-shadow: 0 12px 24px rgba(0,0,0,.25);
        }

            .account-dropdown::before {
                content: "";
                position: absolute;
                top: -12px;
                left: 0;
                right: 0;
                height: 12px;
            }

        .account-hover.open .account-dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .account-dropdown a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #fff;
            text-decoration: none;
            white-space: nowrap;
        }

            .account-dropdown a:hover {
                background: rgba(255,255,255,.08);
            }

        .fav-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 999px;
            color: #fff;
        }

            .fav-wrap.has-badge i {
                color: #ff4d6d;
            }

        .fav-badge {
            position: absolute;
            top: -4px;
            right: -6px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 999px;
            background: #22c55e;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* ===================== DETAIL LAYOUT ===================== */
        .detail-wrap {
            max-width: 1200px;
            margin: 18px auto 24px;
            padding: 0 16px;
        }

        .detail-title {
            margin: 18px 0 14px;
            font-size: 34px;
            font-weight: 900;
            text-align: center;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.55fr .9fr;
            gap: 18px;
            align-items: start;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
            border: 1px solid rgba(15,23,42,.08);
        }

        .section-title {
            margin: 0 0 10px;
            font-size: 16px;
            font-weight: 900;
        }

        /* Preview */
        .preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            display: block;
        }

            .preview img {
                width: 100%;
                height: 380px;
                object-fit: cover;
                display: block;
                background: #f3f4f6;
            }

        .badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(16,185,129,.95);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 12px;
            z-index: 3;
        }

        .play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.35));
            z-index: 2;
        }

            .play .btn {
                width: 64px;
                height: 64px;
                border-radius: 999px;
                background: rgba(15,23,42,.85);
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 10px 24px rgba(0,0,0,.25);
            }

                .play .btn span {
                    color: #fff;
                    font-weight: 900;
                    font-size: 12px;
                    letter-spacing: .6px;
                }

        .hint {
            margin-top: 10px;
            color: #64748b;
            font-size: 13px;
        }

        .danger {
            color: #ef4444;
        }

        /* Right sticky */
        .right {
            position: sticky;
            top: 16px;
        }

        .price {
            font-size: 22px;
            font-weight: 900;
            color: #16a34a;
        }

        .meta {
            margin-top: 8px;
            color: #475569;
        }

        .addr {
            margin-top: 6px;
            color: #475569;
            line-height: 1.5;
        }

        /* Mobile: summary + amenities */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 18px;
        }

        .mobile-summary {
            display: none;
        }

        .desc-card {
            grid-column: auto;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 6px 10px;
            border-radius: 999px;
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 800;
            font-size: 12px;
            border: 1px solid rgba(15,23,42,.08);
        }

        .muted {
            color: #64748b;
        }

        /* Map */
        .map-wrap {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(15,23,42,.08);
        }

            .map-wrap iframe {
                width: 100%;
                height: 280px;
                border: 0;
                display: block;
            }

        .map-open {
            position: absolute;
            right: 10px;
            top: 10px;
            background: rgba(15,23,42,.85);
            color: #fff;
            text-decoration: none;
            padding: 8px 10px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

            .map-open:hover {
                opacity: .95;
            }

        /* ===================== SIMILAR (max 4, scroll ngang) ===================== */
        .similar-scroll {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc((100% - 18px * 2) / 3); /* PC: 3 item */
            gap: 18px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-gutter: stable both-edges;
            align-items: stretch;
        }

            .similar-scroll .property-card {
                scroll-snap-align: start;
                min-width: 0;
                height: 100%;
            }

            .similar-scroll::-webkit-scrollbar {
                height: 8px;
            }

            .similar-scroll::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,.18);
                border-radius: 999px;
            }

            .similar-scroll::-webkit-scrollbar-track {
                background: rgba(0,0,0,.06);
                border-radius: 999px;
            }

        /* Card */
        .property-card {
            position: relative;
            cursor: pointer;
        }

            .property-card a.card-link {
                color: inherit;
                text-decoration: none;
                display: block;
            }

            .property-card img {
                width: 100%;
                height: 160px;
                object-fit: cover;
                display: block;
                background: #f3f4f6;
                border-radius: 12px 12px 0 0;
            }

        .property-card-body {
            padding: 10px 12px 12px;
        }

        .property-card-title {
            font-weight: 900;
            line-height: 1.25;
            max-height: 2.5em;
            overflow: hidden;
        }

        .property-card-address {
            color: #64748b;
            font-size: 13px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-card-meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 6px;
            color: #334155;
            font-size: 13px;
        }

        .property-card-price {
            margin-top: 8px;
            font-weight: 900;
        }

        .property-card-fav {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: rgba(15,23,42,.65);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3;
        }

            .property-card-fav i {
                font-size: 14px;
                color: #fff;
            }

            .property-card-fav.is-fav {
                background: #ef4444;
            }

        /* Fix lệch chiều cao: chỉ áp dụng trong khu Similar */
        .similar-scroll .property-card a.card-link {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .similar-scroll .property-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .similar-scroll .property-card-title {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            min-height: calc(1.25em * 2);
        }

        .similar-scroll .property-card-address {
            min-height: 1.25em;
        }

        .similar-scroll .property-card-meta {
            min-height: 1.25em;
        }

        .similar-scroll .property-card-price {
            margin-top: auto;
        }

        /* ===================== RESPONSIVE ===================== */
        @@media (max-width: 992px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .right {
                display: none;
            }

            .preview img {
                height: 260px;
            }

            .mobile-summary {
                display: block;
            }

            .desc-card {
                grid-column: 1 / -1;
            }

            .similar-scroll {
                grid-auto-columns: calc((100% - 16px) / 2); /* mobile/tablet: 2 item */
                gap: 16px;
            }
        }

        @@media (max-width: 500px) {
            .detail-wrap {
                padding: 0 4px;
            }

            .price {
                font-size: 16px;
                font-weight: 700;
            }

            .property-card-price {
                font-size: .7rem !important;
            }

            .similar-scroll {
                grid-auto-columns: calc((100% - 12px) / 2);
                gap: 12px;
            }
        }
    </style>
}

<!-- HEADER -->
<div class="home-hero list-hero detail-hero">
    <div class="home-hero-shell">
        <div class="home-hero-header">
            <a href="@Url.Action("Index", "Home")" class="home-header-left-box">
                <div class="home-logo-icon"></div>
                <div class="home-header-left">
                    <div class="home-header-left-top"><span>NhàNow</span></div>
                    <div class="home-header-left-tagline">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 2.5C8.96 2.5 6.5 4.96 6.5 8c0 3.74 3.39 7.47 4.96 9.15.29.31.77.31 1.06 0C14.11 15.47 17.5 11.74 17.5 8c0-3.04-2.46-5.5-5.5-5.5zm0 6.5A2 2 0 1 1 12 5a2 2 0 0 1 0 4z" />
                        </svg>
                        @headerCityName
                    </div>
                </div>
            </a>

            <div class="home-header-right-box">
                <div class="home-header-right-top">
                    @if (User.Identity.IsAuthenticated)
                    {
                        var name = Session["CurrentUserName"] as string ?? HomeTexts.Account_Default;

                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top fav-wrap @(favCount > 0 ? "has-badge" : "")"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                            @if (favCount > 0)
                            {
                                <span id="headerFavBadge" class="fav-badge">@favCountText</span>
                            }
                        </a>

                        <a class="hidden-xs" href="javascript:void(0)">
                            <i class="fa-solid fa-bell"></i>
                        </a>

                        <div class="hidden-xs account-hover" id="hnAccountMenu">
                            <button type="button" class="account-trigger" id="hnAccountTrigger" aria-haspopup="menu" aria-expanded="false">
                                <i class="fa-solid fa-user"></i>
                                <span>@name</span>
                                <i class="fa-solid fa-caret-down" style="font-size:12px; opacity:.8;"></i>
                            </button>
                            <div class="account-dropdown" role="menu">
                                <a href="@Url.Action("Logout","Account")" role="menuitem">
                                    <i class="fa-solid fa-right-from-bracket"></i> @HomeTexts.Logout
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top fav-wrap"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                        </a>

                        <a class="hidden-xs" href="javascript:void(0)">
                            <i class="fa-solid fa-bell"></i>
                        </a>

                        <a href="javascript:void(0)" class="hidden-xs js-open-login">@HomeTexts.Login</a>
                    }

                    <a href="@Url.Action("Request", "Landlord")" class="nav-post">
                        @HomeTexts.Menu_Post
                    </a>
                </div>

                <div class="home-header-right-bottom">
                    <a href="@Url.Action("Set", "Language", new { lang = "vi-VN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("vi") ? "lang-active" : "")">VI</a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "en-US", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("en") ? "lang-active" : "")">EN</a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "zh-CN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("zh") ? "lang-active" : "")">中文</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="detail-wrap">
    <h1 class="detail-title">@Model.Title</h1>

    <div class="detail-grid">
        <!-- LEFT -->
        <div>
            <div class="card">
                @if (Model.IsVrAvailable)
                {
                    <a class="preview" href="@Url.Action("Vr","Property", new { id = Model.PropertyId })" style="text-decoration:none;">
                        <span class="badge">VR 360°</span>
                        <img src="@Model.CoverImageUrl" alt="@Model.Title" loading="lazy" decoding="async" />
                        <div class="play"><div class="btn"><span>PLAY</span></div></div>
                    </a>
                    <div class="hint">Click ảnh để vào màn VR</div>
                }
                else
                {
                    <div class="preview">
                        <img src="@Model.CoverImageUrl" alt="@Model.Title" loading="lazy" decoding="async" />
                    </div>
                    <div class="hint danger">Nhà này chưa có VR.</div>
                }
            </div>

            <!-- Mobile: Summary + Amenities -->
            <div class="two-col">
                <div class="card mobile-summary">
                    <div class="price">@Model.PriceLabel</div>
                    <div class="meta">@Model.Area m² · @(Model.BedroomCount ?? 0) PN · @(Model.BathroomCount ?? 0) WC</div>
                    <div class="addr">
                        @Model.AddressLine
                        @if (!string.IsNullOrWhiteSpace(Model.CityName))
                        {
                            @Model.CityName
                        }
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">Tiện ích / Nội thất</h3>
                    @if (Model.Amenities == null || !Model.Amenities.Any())
                    {
                        <div class="muted">Chưa cập nhật.</div>
                    }
                    else
                    {
                        <div class="tags">
                            @foreach (var a in Model.Amenities)
                            {
                                <span class="tag">@a</span>
                            }
                        </div>
                    }
                </div>

                <div class="card desc-card">
                    <h3 class="section-title">Mô tả</h3>
                    <div style="color:#334155; line-height:1.7;">
                        @Html.Raw((Model.Description ?? "").Replace("\n", "<br/>"))
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="card" style="margin-top:18px;">
                <h3 class="section-title">Vị trí trên bản đồ</h3>

                @if (!string.IsNullOrWhiteSpace(Model.MapEmbedUrl))
                {
                    <div class="map-wrap">
                        <a class="map-open" href="@mapOpenUrl" target="_blank" rel="noopener">
                            <i class="fa-solid fa-diamond-turn-right"></i> Chỉ đường
                        </a>
                        <iframe src="@Model.MapEmbedUrl" loading="lazy"></iframe>
                    </div>
                }
                else
                {
                    <div class="muted">Chưa có dữ liệu bản đồ.</div>
                }
            </div>

            <!-- Similar -->
            <div class="card detail-similar" style="margin-top:18px;">
                <h3 class="section-title">Căn hộ tương tự</h3>

                @if (Model.Similar == null || !Model.Similar.Any())
                {
                    <div class="muted">Chưa có dữ liệu.</div>
                }
                else
                {
                    <div class="similar-scroll">
                        @foreach (var s in (Model.Similar ?? new List<PropertyListItemViewModel>()).Take(4))
                        {
                            <div class="property-card">
                                <div class="property-card-fav js-fav-toggle @(s.IsFavorite ? "is-fav" : "")"
                                     data-id="@s.PropertyId"
                                     title="Yêu thích">
                                    <i class="fa-solid fa-heart"></i>
                                </div>

                                <a class="card-link" href="@Url.Action("Detail","Property", new { id = s.PropertyId })">
                                    <img src="@s.ThumbnailUrl" alt="@s.Title" loading="lazy" decoding="async" />
                                    <div class="property-card-body">
                                        <div class="property-card-title">@s.Title</div>
                                        <div class="property-card-address">
                                            <i class="fa-solid fa-location-dot"></i> @s.Address
                                        </div>
                                        <div class="property-card-meta">
                                            <span><i class="fa-solid fa-bed"></i> @(s.Bed ?? 0) PN <i class="fa-solid fa-bath"></i> @(s.Bath ?? 0) WC</span>
                                            <span><i class="fa-solid fa-ruler-combined"></i> @s.Area m²</span>
                                        </div>
                                        <div class="property-card-price">
                                            <i class="fa-solid fa-sack-dollar"></i> @s.PriceLabel @HomeTexts.Currency_VND
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT (desktop only) -->
        <aside class="card right">
            <div class="price">@Model.PriceLabel</div>
            <div class="meta">@Model.Area m² · @(Model.BedroomCount ?? 0) PN · @(Model.BathroomCount ?? 0) WC</div>
            <div class="addr">
                @Model.AddressLine
                @if (!string.IsNullOrWhiteSpace(Model.CityName))
                {
                    @Model.CityName
                }
            </div>
        </aside>
    </div>
</div>

@section Scripts{
    <script>
(function () {
    var menu = document.getElementById('hnAccountMenu');
    var trigger = document.getElementById('hnAccountTrigger');
    if (!menu || !trigger) return;

    trigger.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle('open');
        trigger.setAttribute('aria-expanded', menu.classList.contains('open') ? 'true' : 'false');
    });

    document.addEventListener('click', function () {
        menu.classList.remove('open');
        trigger.setAttribute('aria-expanded', 'false');
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            menu.classList.remove('open');
            trigger.setAttribute('aria-expanded', 'false');
        }
    });
})();

// header favorites realtime
window.__isAuth = @User.Identity.IsAuthenticated.ToString().ToLower();
window.__favIds = window.__favIds || [];

function updateHeaderFavBadge(count) {
    count = parseInt(count || 0, 10);
    var $wrap = $('.js-fav-top.fav-wrap');
    if ($wrap.length === 0) return;

    var $badge = $('#headerFavBadge');

    if (count > 0) {
        var text = count > 99 ? '99+' : String(count);
        $wrap.addClass('has-badge');
        if ($badge.length === 0) $wrap.append('<span id="headerFavBadge" class="fav-badge">' + text + '</span>');
        else $badge.text(text);
    } else {
        $wrap.removeClass('has-badge');
        if ($badge.length) $badge.remove();
    }
}

function applyFavoriteIds(ids, $scope) {
    ids = ids || [];
    var set = {};
    for (var i = 0; i < ids.length; i++) set[ids[i]] = true;

    var $root = $scope && $scope.length ? $scope : $(document);
    $root.find('.js-fav-toggle').each(function () {
        var pid = $(this).data('id');
        $(this).toggleClass('is-fav', !!set[pid]);
    });
}

window.refreshHeaderFav = function () {
    return $.get('@Url.Action("HeaderFavoriteInfo", "Property")')
        .done(function (res) {
            if (!res) return;
            window.__isAuth = !!res.isAuth;
            updateHeaderFavBadge(res.favoriteCount || 0);
            window.__favIds = res.favoriteIds || [];
            applyFavoriteIds(window.__favIds);
        });
};

$(function () {
    window.refreshHeaderFav();
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden) window.refreshHeaderFav();
    });
});

// click heart header: chưa login -> mở login
$(document).on('click', '.js-fav-top', function (e) {
    if (window.__isAuth) return;

    e.preventDefault();
    var returnUrl = $(this).data('return') || (window.location.pathname + window.location.search);

    if (window.loginModal && typeof window.loginModal.open === 'function') {
        window.loginModal.open(returnUrl);
    } else {
        window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent(returnUrl);
    }
});

// Toggle favorite
(function () {
    var MSG_NEED_LOGIN = '@JS_FavNeedLogin';
    var MSG_UPDATE_FAIL = '@JS_FavUpdateFail';

    보여: $(document).on('click', '.js-fav-toggle', function (e) {
        e.preventDefault();
        e.stopPropagation();

        var $btn = $(this);
        var propertyId = $btn.data('id');

        $.ajax({
            url: '@Url.Action("ToggleFavorite", "Property")',
            type: 'POST',
            data: { propertyId: propertyId },
            success: function (res) {
                if (!res) return;

                if (res.needLogin) {
                    if (window.loginModal && typeof window.loginModal.open === 'function') {
                        window.loginModal.open(window.location.pathname + window.location.search);
                    } else {
                        alert(MSG_NEED_LOGIN);
                    }
                    return;
                }

                if (res.success) {
                    $btn.toggleClass('is-fav', !!res.isFavorite);
                    updateHeaderFavBadge(res.favoriteCount || 0);
                    window.__isAuth = true;
                }
            },
            error: function () { alert(MSG_UPDATE_FAIL); }
        });
    });
})();
    </script>
}
