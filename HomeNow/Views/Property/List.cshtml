@model HomeNow.ViewModels.PropertyListPageViewModel
@{
    ViewBag.Title = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}




<style>
    a {
        text-decoration: none !important;
        color: black !important;
       
    }
    .list-shell {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
    }

    .list-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin: 8px 0 14px;
    }

        .list-head h2 {
            margin: 0;
            font-size: 20px;
        }

    .list-tabs {
        display: flex;
        gap: 10px;
    }

        .list-tabs a {
            padding: 8px 12px;
            border-radius: 999px;
            text-decoration: none;
            background: #f1f5f9;
            color: #0f172a;
            font-size: 13px;
        }

            .list-tabs a.active {
                background: #0f172a;
                color: #fff;
            }

    /* Row layout */
    .p-row {
        display: flex;
        gap: 16px;
        padding: 14px;
        border-bottom: 1px solid #eee;
        background: #fff;
    }

    .p-img {
        width: 240px;
        height: 150px;
        border-radius: 10px;
        overflow: hidden;
        flex: 0 0 240px;
        background: #f3f4f6;
        display: block;
    }

        .p-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .p-main {
        flex: 1;
        min-width: 0;
    }

    .p-title {
        display: block;
        font-size: 20px;
        font-weight: 700;
        color: #111827;
        text-decoration: none;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .p-line {
        color: #334155;
        font-size: 14px;
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
    }

    .p-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        color: #475569;
        font-size: 13px;
    }

        .p-meta i {
            margin-right: 6px;
            opacity: .9;
        }

    .p-actions {
        margin-top: 10px;
    }

    .p-fav {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: rgba(15,23,42,.08);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .p-fav i {
            color: #64748b;
        }

        .p-fav.is-fav {
            background: #ef4444;
        }

            .p-fav.is-fav i {
                color: #fff;
            }

    .p-price {
        width: 210px;
        flex: 0 0 210px;
        text-align: right;
        padding-top: 6px;
    }

    .p-price-main {
        font-size: 32px;
        font-weight: 800;
        color: #ef4444;
        line-height: 1;
    }

    @@media(max-width:900px) {
        .p-row {
            flex-direction: column;
        }

        .p-img {
            width: 100%;
            height: 190px;
            flex: 0 0 auto;
        }

        .p-price {
            width: 100%;
            text-align: left;
        }

        .p-price-main {
            font-size: 26px;
        }
    }
</style>

<div class="list-shell">
    <div class="list-head">
        <h2>@Model.Title</h2>

        <div class="list-tabs">
            <a class="@(Model.Mode=="rent" ? "active" : "")"
               href="@Url.Action("List","Property", new {
                    mode="rent",
                    cityId = Model.CityId,
                    priceRange = Model.PriceRange,
                    propertyType = Model.PropertyType,
                    keyword = Model.Keyword
               })">Cho thuê</a>

            <a class="@(Model.Mode=="sale" ? "active" : "")"
               href="@Url.Action("List","Property", new {
                    mode="sale",
                    cityId = Model.CityId,
                    priceRange = Model.PriceRange,
                    propertyType = Model.PropertyType,
                    keyword = Model.Keyword
               })">Bán</a>
        </div>
    </div>

    <div id="list-results">
        @Html.Partial("~/Views/Home/_PropertyRowList.cshtml", Model.Items)
    </div>

    <input type="hidden" id="currentPage" value="@Model.Page" />
    <input type="hidden" id="totalPages" value="@Model.TotalPages" />

    <input type="hidden" id="mode" value="@Model.Mode" />
    <input type="hidden" id="cityId" value="@(Model.CityId.HasValue ? Model.CityId.ToString() : "")" />
    <input type="hidden" id="priceRange" value="@(Model.PriceRange ?? "")" />
    <input type="hidden" id="propertyType" value="@(Model.PropertyType ?? "")" />
    <input type="hidden" id="keyword" value="@(Model.Keyword ?? "")" />

    <div id="load-more-sentinel" style="height:1px;"></div>
</div>

@section Scripts{
    <script>
   
    (function () {
        var $results = $('#list-results');
        if ($results.length === 0) return;

        var currentPage = parseInt($('#currentPage').val() || '1', 10);
        var totalPages = parseInt($('#totalPages').val() || '1', 10);
        var isLoading = false;

        function loadNextPage() {
            if (isLoading) return;
            if (currentPage >= totalPages) return;

            isLoading = true;
            currentPage++;

            var data = {
                mode: $('#mode').val(),
                cityId: $('#cityId').val(),
                priceRange: $('#priceRange').val(),
                propertyType: $('#propertyType').val(),
                keyword: $('#keyword').val(),
                page: currentPage
            };

            $.get('@Url.Action("LoadMoreList", "Property")', data)
                .done(function (html) {
                    if (html && $.trim(html).length > 0) {
                        $results.append(html);
                        $('#currentPage').val(currentPage);
                    } else {
                        currentPage = totalPages;
                    }
                })
                .always(function () { isLoading = false; });
        }

        var sentinel = document.getElementById('load-more-sentinel');
        if ('IntersectionObserver' in window && sentinel) {
            var io = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) loadNextPage();
                });
            }, { rootMargin: '0px 0px 250px 0px', threshold: 0 });

            io.observe(sentinel);
        } else {
            $(window).on('scroll', function () {
                if ($(window).scrollTop() + $(window).height() + 250 >= $(document).height()) {
                    loadNextPage();
                }
            });
        }
    })();

    // Toggle Favorite (giống Home)
    (function () {
        $(document).on('click', '.js-fav-toggle', function (e) {
            e.preventDefault();

            var $btn = $(this);
            var propertyId = $btn.data('id');

            $.ajax({
                url: '@Url.Action("ToggleFavorite", "Property")',
                type: 'POST',
                data: { propertyId: propertyId },
                success: function (res) {
                    if (!res) return;

                    if (res.needLogin) {
                        if (window.loginModal && typeof window.loginModal.open === 'function') {
                            window.loginModal.open(window.location.pathname + window.location.search);
                        } else {
                            alert('Bạn cần đăng nhập để sử dụng chức năng Yêu thích.');
                        }
                        return;
                    }

                    if (res.success) {
                        $btn.toggleClass('is-fav', !!res.isFavorite);
                    }
                }
            });
        });
    })();
    </script>
}
