@using HomeNow.Resources
@using Core.Models
@using System.Web
@using System.Linq
@using System.Collections.Generic

@model Core.Models.HomeIndexViewModel

@{

    Func<string, string, string> R = (key, fallback) =>
    {
        var s = HomeTexts.ResourceManager.GetString(key, System.Threading.Thread.CurrentThread.CurrentUICulture);
        return string.IsNullOrWhiteSpace(s) ? fallback : s;
    };

    var mode = string.IsNullOrWhiteSpace(Model.TransactionType) ? "rent" : Model.TransactionType;
    mode = mode.ToLower();

  
    ViewBag.Title = (mode == "rent")
        ? R("List_Title_AllRent", "Tất cả căn cho thuê")
        : R("List_Title_AllSale", "Tất cả căn bán");

    Layout = "~/Views/Shared/_Layout.cshtml";

    var selectedCity = Model.CityId.HasValue
        ? (Model.Cities ?? new List<CityDropDownItem>()).FirstOrDefault(x => x.CityId == Model.CityId.Value)
        : (Model.Cities ?? new List<CityDropDownItem>()).FirstOrDefault();

    var headerCityName = selectedCity?.Name ?? HomeTexts.CityName;

    // ✅ Header dùng chung sẽ đọc ViewBag này
    ViewBag.HeaderCityName = headerCityName;

    var ROW_PARTIAL = "~/Views/Home/_PropertyRowList.cshtml";
}

@section PageHeader{
    @Html.Partial("~/Views/Shared/_TopHeaderBar.cshtml")
}

@section Styles{
    <link rel="stylesheet" href="~/Content/font-awesome/all.min.css">
    <link rel="stylesheet" href="~/Content/style/Property/List.css" />

    <style>
        /* ===== LIST PAGE (body) ===== */
        .home-search-wrapper {
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
            padding: 8px 10px 6px;
            width: 80%;
            margin: 0 auto;
            box-sizing: border-box;
            flex-direction: column;
            gap: 4px;
        }

        .list-shell {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .list-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: auto;
            width: 79%;
        }

            .list-head h2 {
                margin: 0;
                font-size: 20px;
            }

        .list-results_class {
            width: 80%;
            margin: auto;
        }

        .p-row {
            display: flex;
            gap: 16px;
            padding: 14px;
            border-bottom: 1px solid #eee;
            background: #fff;
            flex-wrap: nowrap;
            align-items: flex-start;
        }

        .p-img {
            width: 240px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            flex: 0 0 240px;
            background: #f3f4f6;
            display: block;
        }

            .p-img img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .p-main {
            flex: 1;
            min-width: 0;
        }

        .p-title {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .p-line {
            color: #334155;
            font-size: 14px;
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .p-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            color: #475569;
            font-size: 13px;
        }

            .p-meta i {
                margin-right: 6px;
                opacity: .9;
            }

        .p-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 10px
        }

        .p-price-mobile {
            display: none;
            margin-left: auto;
        }

        .p-price {
            width: 210px;
            flex: 0 0 210px;
            text-align: right;
            padding-top: 6px;
        }

        .p-price-main {
            font-size: 18px;
            font-weight: 600;
            color: #ef4444;
            line-height: 1.1;
        }

        .list-shell .js-fav-toggle {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            border: none !important;
            outline: none;
            cursor: pointer;
            background: rgba(15, 23, 42, .08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            .list-shell .js-fav-toggle i {
                color: #64748b !important;
            }

            .list-shell .js-fav-toggle.is-fav {
                background: #ef4444 !important;
            }

                .list-shell .js-fav-toggle.is-fav i {
                    color: #fff !important;
                }

        @@media(max-width:900px) {
            .home-search-wrapper {
                width: 97%;
            }

            .list-head {
                width: 97%;
            }

            .list-results_class {
                width: 97%;
            }

            .p-row {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 12px;
                padding: 12px;
            }

            .p-img {
                width: 140px;
                height: 100px;
                flex: 0 0 140px;
            }

            .p-title {
                font-size: 14px;
                white-space: normal;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .p-price-main {
                font-size: 16px;
            }

            .p-meta {
                gap: 10px;
                font-size: 12px;
            }

            .p-line {
                font-size: 12px;
            }
        }

        @@media(max-width:677px) {
            .p-price {
                display: none !important;
            }

            .p-price-mobile {
                display: block !important;
            }

            .p-actions {
                padding-top: 5px
            }
        }

        .scroll-top-btn {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: rgba(15,23,42,.85);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0,0,0,.25);
            cursor: pointer;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity .2s ease, transform .2s ease;
            text-decoration: none;
        }

            .scroll-top-btn.show {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(0);
            }

        @@media(max-width:500px) {
            .scroll-top-btn {
                right: 12px;
                bottom: 12px;
            }

            .list-shell {
                padding: 0px;
            }

            .p-row {
                gap: 10px;
            }

            .p-img {
                width: 110px;
                height: 80px;
                flex: 0 0 110px;
            }

            .p-price-main {
                font-size: 15px !important;
                white-space: nowrap;
            }
        }

        #listLoadMoreSpinner {
            display: none;
            text-align: center;
            padding: 12px;
            opacity: .7;
        }
    </style>
}

<div class="list-shell">

    @using (Html.BeginForm("List", "Property", FormMethod.Get, new { id = "listSearchForm", @class = "home-search-form" }))
    {
        <div class="home-search-wrapper" style="margin-bottom:12px;">
            <div class="home-search-top">
                <div class="home-search-tabs">
                    <button type="button" class="home-search-tab-btn @(mode == "rent" ? "active" : "")" data-value="rent">@HomeTexts.Tab_Rent</button>
                    <span style="color:#aaa">|</span>
                    <button type="button" class="home-search-tab-btn @(mode == "sale" ? "active" : "")" data-value="sale">@HomeTexts.Tab_Sale</button>
                </div>

                <div class="home-search-input-wrap">
                    <input type="text" name="keyword" value="@(Model.Keyword ?? "")" placeholder="@HomeTexts.Search_Placeholder" />
                </div>

                <button type="submit" class="home-search-btn-main">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>

            <input type="hidden" name="mode" id="modeInput" value="@mode" />

            <div class="home-search-bottom">
                <div class="home-search-filter">
                    <select name="cityId" id="cityId" class="home-search-filter-select">
                        <option value="">@HomeTexts.Filter_City</option>
                        @foreach (var c in (Model.Cities ?? new List<CityDropDownItem>()))
                        {
                            <option value="@c.CityId" @(Model.CityId == c.CityId ? "selected" : "")>@c.Name</option>
                        }
                    </select>
                </div>

                <div class="home-search-filter">
                    <select name="priceRange" id="priceRange" class="home-search-filter-select">
                        <option value="">@HomeTexts.Filter_Price</option>
                        @foreach (var pf in (Model.PriceFilters ?? new List<PriceFilterDropDownItem>()))
                        {
                            <option value="@pf.Code" @(Model.PriceRange == pf.Code ? "selected" : "")>@pf.Name</option>
                        }
                    </select>
                </div>

                <div class="home-search-filter">
                    <select name="propertyType" id="propertyType" class="home-search-filter-select">
                        <option value="">@HomeTexts.Filter_PropertyType</option>
                        @foreach (var pt in (Model.PropertyTypes ?? new List<PropertyTypeDropDownItem>()))
                        {
                            <option value="@pt.Code" @(Model.PropertyType == pt.Code ? "selected" : "")>@pt.Name</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    }

    <div class="list-head">
        <h2>@ViewBag.Title</h2>
    </div>

    <div id="list-results" class="list-results_class">
        @Html.Partial(ROW_PARTIAL, Model.SearchResults ?? new List<PropertyListItemViewModel>())
    </div>

    <input type="hidden" id="currentPage" value="@Model.Page" />
    <input type="hidden" id="totalPages" value="@Model.TotalPages" />

    <div id="load-more-sentinel" style="height:1px;"></div>
    <div id="listLoadMoreSpinner"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
</div>

<!--Scroll to top button -->
<a href="#" id="scrollTopBtn" class="scroll-top-btn" aria-label="@R("Common_ScrollTop","Về đầu trang")">
    <i class="fa-solid fa-angles-up"></i>
</a>

@section Scripts{
    <script>
    // tabs rent/sale
    (function () {
        var buttons = document.querySelectorAll(".home-search-tab-btn");
        var hidden = document.getElementById("modeInput");
        if (!hidden || !buttons.length) return;

        buttons.forEach(function (btn) {
            btn.addEventListener("click", function () {
                var val = this.getAttribute("data-value");
                hidden.value = val;
                buttons.forEach(function (b) { b.classList.remove("active"); });
                this.classList.add("active");
            });
        });
    })();

    // Infinite scroll
    (function () {
        var $results = $('#list-results');
        if ($results.length === 0) return;

        var $spinner = $('#listLoadMoreSpinner');

        var currentPage = parseInt($('#currentPage').val() || '1', 10);
        var totalPages  = parseInt($('#totalPages').val() || '1', 10);
        var isLoading = false;

        var sentinel = document.getElementById('load-more-sentinel');
        var io = null;

        function buildQuery(page) {
            return {
                mode: $('#modeInput').val(),
                cityId: $('#cityId').val(),
                priceRange: $('#priceRange').val(),
                propertyType: $('#propertyType').val(),
                keyword: $('input[name="keyword"]').val(),
                page: page
            };
        }

        function stop() { if (io) io.disconnect(); }
        function observe() { if (io && sentinel) io.observe(sentinel); }
        function unobserve() { if (io && sentinel) io.unobserve(sentinel); }

        function applyFavOnScope() {
            // ✅ function này nằm trong _TopHeaderBar.cshtml
            if (window.__isAuth && window.__favIds && window.__favIds.length && typeof window.applyFavoriteIds === 'function') {
                window.applyFavoriteIds(window.__favIds, $results);
            }
        }

        function loadNextPage() {
            if (isLoading) return;
            if (currentPage >= totalPages) { stop(); return; }

            isLoading = true;
            currentPage++;
            unobserve();
            $spinner.show();

            $.get('@Url.Action("LoadMoreList", "Property")', buildQuery(currentPage))
                .done(function (html) {
                    if (html && $.trim(html).length > 0) {
                        var $chunk = $('<div/>').html(html);
                        $results.append($chunk.contents());

                        $('#currentPage').val(currentPage);
                        applyFavOnScope();
                    } else {
                        currentPage = totalPages;
                    }
                })
                .fail(function () {
                    currentPage--;
                })
                .always(function () {
                    isLoading = false;
                    $spinner.hide();

                    if (currentPage >= totalPages) stop();
                    else observe();
                });
        }

        if ('IntersectionObserver' in window && sentinel) {
            io = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) loadNextPage();
                });
            }, { root: null, rootMargin: '0px 0px 700px 0px', threshold: 0 });

            observe();
        } else {
            var ticking = false;
            $(window).on('scroll', function () {
                if (ticking) return;
                ticking = true;

                requestAnimationFrame(function () {
                    ticking = false;
                    if ($(window).scrollTop() + $(window).height() + 700 >= $(document).height()) {
                        loadNextPage();
                    }
                });
            });
        }
    })();

    // scroll to top
    (function () {
        var $btn = $('#scrollTopBtn');
        if ($btn.length === 0) return;

        $(window).on('scroll', function () {
            if ($(this).scrollTop() > window.innerHeight) $btn.addClass('show');
            else $btn.removeClass('show');
        });

        $btn.on('click', function (e) {
            e.preventDefault();
            $('html, body').animate({ scrollTop: 0 }, 400);
        });
    })();
    </script>
}
