@model HomeNow.ViewModels.VrViewModel
@using System.Globalization
@using System.Web

@{
    Layout = null;
    var lang = Model.Lang;
    var sceneList = Model.Scenes.ToList();
    var firstSceneKey = sceneList.FirstOrDefault(s => s.IsDefault)?.SceneKey ?? sceneList.First().SceneKey;

    var pid = (int)(ViewBag.PropertyId ?? 0);
    var CI = CultureInfo.InvariantCulture;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>VR Demo</title>

    <link rel="stylesheet" href="~/Content/pannellum/pannellum.css" />
    <script src="~/Content/pannellum/pannellum.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial,sans-serif;
            background: #000;
        }

        #vr {
            width: 100%;
            height: 100vh;
            background: #000;
        }

            #vr canvas {
                image-rendering: auto;
                filter: contrast(1.04) saturate(1.03);
            }

        .pnlm-load-box, .pnlm-loader, .pnlm-load-box p {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        .pnlm-orientation-button {
            display: none !important;
        }

        /* Hotspot */
        .footspot {
            width: 23px;
            height: 19px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.30);
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 12px rgba(0,0,0,0.30);
        }

        .pnlm-hotspot-icon {
            display: none !important;
        }

        /* Close button */
        .vr-close {
            position: fixed;
            right: 12px;
            top: 12px;
            z-index: 10000;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            background: rgba(15,23,42,.75);
            color: #fff;
            text-decoration: none;
            font-weight: 900;
            font-size: 20px;
            line-height: 1;
        }

            .vr-close:hover {
                background: rgba(15,23,42,.90);
            }

        /* UI Panel */
        #ui-panel {
            position: fixed;
            right: 10px;
            bottom: 10px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        #minimap {
            background: rgba(0,0,0,0.30);
            color: #fff;
            padding: 8px;
            border-radius: 8px;
            min-width: 180px;
            backdrop-filter: blur(4px);
        }

        #minimap-title {
            font-size: 12px;
            margin-bottom: 4px;
            opacity: .85;
        }

        .minimap-room {
            font-size: 12px;
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.08);
            user-select: none;
        }

            .minimap-room:hover {
                background: rgba(255,255,255,0.20);
            }

            .minimap-room.active {
                background: rgba(0,200,255,0.60);
            }

        #hotspot-mode-btn, #autorun-btn {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: rgba(255,255,255,0.90);
        }

            #hotspot-mode-btn.on {
                background: #00c853;
                color: #fff;
            }

            #autorun-btn.on {
                background: #2196f3;
                color: #fff;
            }

        #coords-panel {
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            max-width: 320px;
            line-height: 1.35;
        }
    </style>
</head>
<body>
    <a class="vr-close"
       href="@Url.Action("Detail","Property", new { id = pid })"
       title="Đóng VR"
       aria-label="Đóng VR">✕</a>

    <div id="vr"></div>

    <div id="ui-panel">
        <div id="minimap">
            <div id="minimap-title">Sơ đồ phòng (click để chuyển):</div>
            @foreach (var s in sceneList)
            {
                var title = s.Translations?.FirstOrDefault(t => t.LangCode == lang)?.Title ?? s.Title;
                <div class="minimap-room" data-scene="@s.SceneKey">@title</div>
            }
        </div>

        <button id="hotspot-mode-btn">Chế độ tạo hotspot: OFF</button>
        <button id="autorun-btn">Tự chạy: OFF</button>
        <div id="coords-panel">Scene: (chưa) | pitch: - | yaw: - | hfov: -</div>
    </div>

    <script>
        (function () {
            'use strict';

            var isMobile = (window.matchMedia && window.matchMedia('(pointer:coarse)').matches)
                || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            var viewer = null;
            var hotspotMode = false;
            var autorunOn = false;

            // Lưu ý: HFOV nhỏ = zoom gần; HFOV lớn = góc rộng hơn
            var HFOV_DEFAULT = isMobile ? 95 : 110;
            var HFOV_MIN = isMobile ? 82 : 70;
            var HFOV_MAX = 130; // cho phép rộng hơn 120 nếu bạn muốn

            var sceneBusy = false;

            function pickDprCap() {
                var dpr = window.devicePixelRatio || 1;
                var mem = navigator.deviceMemory || 0;
                var lowMem = mem > 0 && mem <= 4;
                var cap = (isMobile || lowMem) ? 1.5 : 2.0;
                return Math.min(dpr, cap);
            }

            function upscaleCanvas() {
                try {
                    var vr = document.getElementById('vr');
                    if (!vr) return;
                    var canvas = vr.querySelector('canvas');
                    if (!canvas) return;

                    var dpr = pickDprCap();
                    var w = Math.floor(canvas.clientWidth * dpr);
                    var h = Math.floor(canvas.clientHeight * dpr);
                    if (w <= 0 || h <= 0) return;

                    if (canvas.width !== w || canvas.height !== h) {
                        canvas.width = w;
                        canvas.height = h;
                    }
                } catch (_) { }
            }

            var resizeTimer = null;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(upscaleCanvas, 180);
            });

            function panel() { return document.getElementById('coords-panel'); }
            function show(msg) { if (panel()) panel().textContent = msg; }

            function logError(where, err) {
                console.error('[VR ERROR] ' + where, err);
                var msg = where + (err && err.message ? (' - ' + err.message) : '');
                show('VR gặp lỗi: ' + msg);
            }

            window.addEventListener('error', function (e) {
                logError('JS global error', e.error || e.message || e);
            });

            window.addEventListener('unhandledrejection', function (e) {
                logError('Unhandled promise rejection', e.reason || e);
            });

            // ====== Build config from DB ======
            var config = {
                "default": {
                    "firstScene": "@firstSceneKey",
                    "author": "HomeNow VR",
                    "autoLoad": true,
                    "sceneFadeDuration": 250,

                    "hfov": HFOV_DEFAULT,
                    "minHfov": HFOV_MIN,
                    "maxHfov": HFOV_MAX,

                    "mouseZoom": true,
                    "doubleClickZoom": !isMobile,

                    "orientationOnByDefault": false,
                    "compass": false,
                    "friction": isMobile ? 0.70 : 0.45
                },
                "scenes": {
@{
    for (int i = 0; i < sceneList.Count; i++)
    {
        var s = sceneList[i];
        var title = s.Translations?.FirstOrDefault(t => t.LangCode == lang)?.Title ?? s.Title;

        var panoType = (s.PanoType ?? "equirect").ToLowerInvariant();
        var panoUrl = Url.Content(s.PanoramaUrl ?? "");
        var previewUrl = string.IsNullOrWhiteSpace(s.PreviewUrl) ? "" : Url.Content(s.PreviewUrl);

        var hs = s.Hotspots?.ToList() ?? new List<Core.Models.VrHotspot>();

@:                    "@s.SceneKey": {
@:                        "title": "@HttpUtility.JavaScriptStringEncode(title)",

        if (panoType == "multires")
        {
            var tileRes = s.TileResolution;
            var maxLv = s.MaxLevel;
            var cubeRes = s.CubeResolution;

            var mrPath = string.IsNullOrWhiteSpace(s.MrPath) ? "/%l/%s%y_%x" : s.MrPath;
            var mrFallback = string.IsNullOrWhiteSpace(s.MrFallbackPath) ? "/fallback" : s.MrFallbackPath;
            var mrExt = string.IsNullOrWhiteSpace(s.MrExtension) ? "jpg" : s.MrExtension;

@:                        "type": "multires",
@:                        "multiRes": {
@:                            "basePath": "@HttpUtility.JavaScriptStringEncode(panoUrl)",
@:                            "path": "@HttpUtility.JavaScriptStringEncode(mrPath)",
@:                            "fallbackPath": "@HttpUtility.JavaScriptStringEncode(mrFallback)",
@:                            "extension": "@HttpUtility.JavaScriptStringEncode(mrExt)",
@:                            "tileResolution": @tileRes,
@:                            "maxLevel": @maxLv,
@:                            "cubeResolution": @cubeRes
@:                        },
            if (!string.IsNullOrWhiteSpace(previewUrl))
            {
@:                        "preview": "@HttpUtility.JavaScriptStringEncode(previewUrl)",
            }
        }
        else
        {
@:                        "panorama": "@HttpUtility.JavaScriptStringEncode(panoUrl)",
        }

@:                        "hfov": @s.Hfov.ToString(CI),
@:                        "pitch": @s.Pitch.ToString(CI),
@:                        "yaw": @s.Yaw.ToString(CI),
@:                        "hotSpots": [

        for (int j = 0; j < hs.Count; j++)
        {
            var h = hs[j];
            var ht = h.Translations?.FirstOrDefault(t => t.LangCode == lang)?.Text ?? h.Text;

            var tp = h.TargetPitch.HasValue ? h.TargetPitch.Value.ToString(CI) : "null";
            var ty = h.TargetYaw.HasValue ? h.TargetYaw.Value.ToString(CI) : "null";
            var th = h.TargetHfov.HasValue ? h.TargetHfov.Value.ToString(CI) : "null";

@:                            {
@:                                "pitch": @h.Pitch.ToString(CI),
@:                                "yaw": @h.Yaw.ToString(CI),
@:                                "type": "info",
@:                                "text": "@HttpUtility.JavaScriptStringEncode(ht)",
@:                                "cssClass": "footspot",
@:                                "clickHandlerFunc": walkToScene,
@:                                "clickHandlerArgs": {
@:                                    "sceneId": "@HttpUtility.JavaScriptStringEncode(h.TargetSceneKey)",
@:                                    "targetPitch": @Html.Raw(tp),
@:                                    "targetYaw": @Html.Raw(ty),
@:                                    "targetHfov": @Html.Raw(th)
@:                                }
@:                            }@(j < hs.Count - 1 ? "," : "")
        }

@:                        ]
@:                    }@(i < sceneList.Count - 1 ? "," : "")
    }
}
                }
            };

            // ===== KEY FIX: dùng pendingTargetView để apply view ĐÚNG SAU KHI scenechange/load =====
            var pendingTargetView = null;

            function clampHfov(v) {
                if (v === null || v === undefined) return null;
                var n = Number(v);
                if (isNaN(n)) return null;
                return Math.max(HFOV_MIN, Math.min(HFOV_MAX, n));
            }

            function resolveTargetView(sceneId, args) {
                var sc = config.scenes && config.scenes[sceneId] ? config.scenes[sceneId] : null;

                var pitch = (args && args.targetPitch !== null && args.targetPitch !== undefined) ? Number(args.targetPitch)
                    : (sc && sc.pitch !== undefined ? Number(sc.pitch) : 0);

                var yaw = (args && args.targetYaw !== null && args.targetYaw !== undefined) ? Number(args.targetYaw)
                    : (sc && sc.yaw !== undefined ? Number(sc.yaw) : 0);

                var hfov = (args && args.targetHfov !== null && args.targetHfov !== undefined) ? clampHfov(args.targetHfov)
                    : (sc && sc.hfov !== undefined ? clampHfov(sc.hfov) : clampHfov(HFOV_DEFAULT));

                if (isNaN(pitch)) pitch = 0;
                if (isNaN(yaw)) yaw = 0;
                if (hfov === null) hfov = clampHfov(HFOV_DEFAULT);

                return { pitch: pitch, yaw: yaw, hfov: hfov };
            }

            function applyTargetNow(sceneId) {
                if (!viewer || !pendingTargetView) return;
                if (pendingTargetView.sceneId !== sceneId) return;

                try {
                    var v = pendingTargetView.view;
                    // set view nhẹ nhàng
                    viewer.setPitch(v.pitch, 220);
                    viewer.setYaw(v.yaw, 220);
                    viewer.setHfov(v.hfov, 220);
                } catch (e) {
                    logError('applyTargetNow', e);
                } finally {
                    pendingTargetView = null;
                }
            }

            function walkToScene(hotSpot, args) {
                if (!viewer) return;
                if (!args || !args.sceneId) return;
                if (!config.scenes || !config.scenes[args.sceneId]) return;

                if (sceneBusy) return;
                sceneBusy = true;
                setTimeout(function () { sceneBusy = false; }, 420);

                try {
                    // zoom-in nhẹ (tạo cảm giác “bước tới”)
                    var zoomIn = Math.max(HFOV_MIN, viewer.getHfov() - 12);
                    viewer.setHfov(zoomIn, 140);

                    // resolve target view (DB target_* > scene default)
                    var v = resolveTargetView(args.sceneId, args);
                    pendingTargetView = { sceneId: args.sceneId, view: v };

                    setTimeout(function () {
                        try {
                            // IMPORTANT: loadScene với pitch/yaw/hfov ngay từ đầu
                            viewer.loadScene(args.sceneId, v.pitch, v.yaw, v.hfov);

                            // upscale nét lại
                            setTimeout(upscaleCanvas, 90);
                        } catch (e2) {
                            logError('loadScene ' + args.sceneId, e2);
                        }
                    }, 140);
                } catch (e) {
                    logError('walkToScene', e);
                }
            }

            function updateMinimapActive(sceneId) {
                document.querySelectorAll('.minimap-room').forEach(function (el) {
                    el.classList.toggle('active', el.getAttribute('data-scene') === sceneId);
                });
            }

            function initUiEvents() {
                document.querySelectorAll('.minimap-room').forEach(function (el) {
                    el.addEventListener('click', function () {
                        var sceneId = el.getAttribute('data-scene');
                        // click minimap => dùng default view của scene
                        walkToScene(null, { sceneId: sceneId });
                    });
                });

                var btn = document.getElementById('hotspot-mode-btn');
                btn.addEventListener('click', function () {
                    hotspotMode = !hotspotMode;
                    btn.classList.toggle('on', hotspotMode);
                    btn.textContent = hotspotMode ? 'Chế độ tạo hotspot: ON' : 'Chế độ tạo hotspot: OFF';
                });

                var autorunBtn = document.getElementById('autorun-btn');
                autorunBtn.addEventListener('click', function () {
                    if (!viewer) return;
                    autorunOn = !autorunOn;

                    if (autorunOn) {
                        viewer.startAutoRotate(isMobile ? -0.18 : -0.9);
                        autorunBtn.classList.add('on');
                        autorunBtn.textContent = 'Tự chạy: ON';
                    } else {
                        viewer.stopAutoRotate();
                        autorunBtn.classList.remove('on');
                        autorunBtn.textContent = 'Tự chạy: OFF';
                    }
                });
            }

            function registerViewerEvents() {
                if (!viewer) return;

                viewer.on('scenechange', function (sceneId) {
                    updateMinimapActive(sceneId);

                    // KEY FIX: scenechange xong apply target lần nữa để chắc chắn không bị “quay ngược”
                    setTimeout(function () { applyTargetNow(sceneId); }, 40);

                    try {
                        var p = viewer.getPitch().toFixed(2);
                        var y = viewer.getYaw().toFixed(2);
                        var h = viewer.getHfov().toFixed(2);
                        show('Scene: ' + sceneId + ' | pitch: ' + p + ' | yaw: ' + y + ' | hfov: ' + h);
                    } catch (_) { }

                    setTimeout(upscaleCanvas, 90);
                });

                viewer.on('load', function () {
                    // load xong apply target lần nữa (tránh race)
                    try {
                        var sid = viewer.getScene();
                        setTimeout(function(){ applyTargetNow(sid); }, 40);
                    } catch (_) { }

                    setTimeout(upscaleCanvas, 80);
                });

                // Hotspot capture mode: click -> log pitch/yaw/hfov
                viewer.on('mousedown', function (event) {
                    if (!hotspotMode) return;
                    try {
                        var coords = viewer.mouseEventToCoords(event);
                        if (!coords) return;

                        var pitch = coords[0].toFixed(2);
                        var yaw = coords[1].toFixed(2);
                        var hfov = viewer.getHfov().toFixed(2);
                        var sceneId = viewer.getScene();

                        var text = 'Scene: ' + sceneId + ' | pitch: ' + pitch + ' | yaw: ' + yaw + ' | hfov: ' + hfov;
                        show(text);
                        console.log(text);
                    } catch (e) {
                        logError('capture coords', e);
                    }
                });
            }

            function initViewer() {
                try {
                    viewer = pannellum.viewer('vr', config);
                    initUiEvents();
                    registerViewerEvents();
                    updateMinimapActive(viewer.getScene());
                    setTimeout(upscaleCanvas, 120);
                } catch (e) {
                    logError('initViewer', e);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initViewer);
            } else {
                initViewer();
            }
        })();
    </script>
</body>
</html>
