@model HomeNow.ViewModels.VrViewModel
@{
    Layout = null; // toàn màn hình VR, không dùng _Layout
    var lang = Model.Lang;
    var sceneList = Model.Scenes.ToList();
    var firstSceneKey = sceneList.FirstOrDefault(s => s.IsDefault)?.SceneKey ?? sceneList.First().SceneKey;

}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>VR Demo</title>

    <link rel="stylesheet" href="~/Content/pannellum/pannellum.css" />
    <script src="~/Content/pannellum/pannellum.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }

        #vr {
            width: 100%;
            height: 100vh;
            margin: auto;
            background: #000;
        }

            /* Tối ưu nét nhẹ */
            #vr canvas {
                image-rendering: auto;
                filter: contrast(1.04) saturate(1.03);
            }

        /* Ẩn loading spinner của Pannellum */
        .pnlm-load-box,
        .pnlm-loader,
        .pnlm-load-box p {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* ------- Checkpoint: vòng tròn trên sàn ------- */
        .footspot {
            width: 23px;
            height: 19px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
        }

            .footspot .pnlm-tooltip {
                font-size: 12px;
                padding: 2px 6px;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 4px;
                display: none;
                white-space: nowrap;
            }

            .footspot:hover .pnlm-tooltip {
                display: block;
            }

        .pnlm-hotspot-icon {
            display: none !important;
        }

        /* ------- UI: minimap & panel bên phải ------- */
        #ui-panel {
            position: fixed;
            right: 10px;
            bottom: 10px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        #minimap {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            padding: 8px;
            border-radius: 8px;
            min-width: 180px;
            backdrop-filter: blur(4px);
        }

        #minimap-title {
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .minimap-room {
            font-size: 12px;
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.08);
            user-select: none;
        }

            .minimap-room:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .minimap-room.active {
                background: rgba(0, 200, 255, 0.6);
            }

        #hotspot-mode-btn,
        #autorun-btn {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
        }

            #hotspot-mode-btn.on {
                background: #00c853;
                color: #fff;
            }

            #autorun-btn.on {
                background: #2196f3;
                color: #fff;
            }

        #coords-panel {
            font-size: 11px;
            padding: 4px 6px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.65);
            color: #fff;
            max-width: 260px;
            line-height: 1.35;
        }
    </style>
</head>
<body>
    @{
    var pid = (int)(ViewBag.PropertyId ?? 0);
    }
    <a href="@Url.Action("Detail","Property", new { id = pid })"
       style="position:fixed;left:12px;top:12px;z-index:10000;
          padding:10px 12px;border-radius:12px;
          background:rgba(15,23,42,.75);color:#fff;text-decoration:none;font-weight:800;">
        ← Quay lại
    </a>

    <div id="vr"></div>

    <!-- UI phụ: minimap + chế độ tạo hotspot + auto run -->
    <div id="ui-panel">
        <div id="minimap">
            <div id="minimap-title">Sơ đồ phòng (click để chuyển):</div>
            @* sinh minimap theo scene trong DB *@
            @foreach (var s in sceneList)
            {
                var title = s.Translations
                             ?.FirstOrDefault(t => t.LangCode == lang)?.Title
                             ?? s.Title;
            <div class="minimap-room" data-scene="@s.SceneKey">@title</div>
            }
        </div>

        <button id="hotspot-mode-btn">Chế độ tạo hotspot: OFF</button>
        <button id="autorun-btn">Tự chạy: OFF</button>

        <div id="coords-panel">
            Scene: (chưa) | pitch: - | yaw: -
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            var viewer = null;
            var hotspotMode = false;
            var autorunOn = false;

            //  OPT: detect mobile
            var isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            // ======= OPT: zoom limit (không zoom sâu)
            var HFOV_DEFAULT = isMobile ? 95 : 110;
            var HFOV_MIN = isMobile ? 80 : 70;
            var HFOV_MAX = 120;

            // ======= OPT: chống giật khi spam click
            var sceneBusy = false;
            var sceneBusyTimer = null;

            // ======= OPT: nâng độ nét canvas theo DPR có giới hạn
            function pickDprCap() {
                var dpr = window.devicePixelRatio || 1;
                var mem = navigator.deviceMemory || 0; // Chrome
                var lowMem = mem > 0 && mem <= 4;

                // PC: cap 2.0; mobile/low mem: cap 1.5 (mượt hơn)
                var cap = (isMobile || lowMem) ? 1.5 : 2.0;
                return Math.min(dpr, cap);
            }

            function upscaleCanvas() {
                try {
                    var vr = document.getElementById('vr');
                    if (!vr) return;
                    var canvas = vr.querySelector('canvas');
                    if (!canvas) return;

                    var dpr = pickDprCap();
                    var w = Math.floor(canvas.clientWidth * dpr);
                    var h = Math.floor(canvas.clientHeight * dpr);

                    if (w <= 0 || h <= 0) return;

                    if (canvas.width !== w || canvas.height !== h) {
                        canvas.width = w;
                        canvas.height = h;
                    }
                } catch (e) {
                    // đừng làm crash
                }
            }

            var resizeTimer = null;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function () {
                    upscaleCanvas();
                }, 180);
            });

            function getCoordsPanel() {
                return document.getElementById('coords-panel');
            }

            function showUserMessage(message) {
                var panel = getCoordsPanel();
                if (panel) panel.textContent = message;
            }

            function logError(where, err) {
                console.error('[VR ERROR] ' + where, err);
                var msg = where;
                if (err && err.message) msg += ' - ' + err.message;
                showUserMessage('VR gặp lỗi: ' + msg);
            }

            // Global error handler
            window.addEventListener('error', function (e) {
                logError('Lỗi JavaScript toàn cục', e.error || e.message || e);
            });

            window.addEventListener('unhandledrejection', function (e) {
                logError('Promise bị reject mà không catch', e.reason || e);
            });

            // ---------- Hàm chuyển cảnh kiểu "lao về phía trước" ----------
            function walkToScene(hotSpot, args) {
                if (!viewer) { console.warn('[VR] walkToScene nhưng viewer chưa sẵn sàng'); return; }
                if (!args || !args.sceneId) { console.warn('[VR] walkToScene: thiếu sceneId'); return; }
                if (!config.scenes || !config.scenes[args.sceneId]) { console.warn('[VR] Scene đích không tồn tại: ' + args.sceneId); return; }

                if (sceneBusy) return; // OPT: chặn spam
                sceneBusy = true;
                clearTimeout(sceneBusyTimer);
                sceneBusyTimer = setTimeout(function () { sceneBusy = false; }, 450);

                try {
                    // zoom-in nhẹ (không sâu)
                    viewer.setHfov(Math.max(HFOV_MIN, HFOV_DEFAULT - 20), 180);

                    setTimeout(function () {
                        try {
                            if (!viewer) return;
                            if (!config.scenes[args.sceneId]) return;

                            // load scene + set hướng
                            viewer.loadScene(args.sceneId, args.targetPitch || 0, args.targetYaw || 0);

                            // zoom-out về mặc định
                            viewer.setHfov(HFOV_DEFAULT, 220);

                            // OPT: upscale sau đổi scene để nét hơn
                            setTimeout(upscaleCanvas, 90);
                        } catch (err2) {
                            logError('Lỗi load scene ' + args.sceneId, err2);
                        }
                    }, 160);
                } catch (err) {
                    logError('Lỗi trong walkToScene', err);
                    sceneBusy = false;
                }
            }

            // --------- CẤU HÌNH VR LẤY TỪ DB (server sinh ra) ----------
            var config = {
                "default": {
                    "firstScene": "@firstSceneKey",
                    "author": "HomeNow VR",
                    "sceneFadeDuration": 0,
                    "autoLoad": true,

                    // OPT: zoom range
                    "hfov": HFOV_DEFAULT,
                    "minHfov": HFOV_MIN,
                    "maxHfov": HFOV_MAX,

                    // OPT: PC cho con lăn zoom, mobile tắt để đỡ say
                    "mouseZoom": !isMobile,

                    // OPT: giảm trôi
                    "friction": isMobile ? 0.55 : 0.35,

                    // OPT: không bật cảm biến mặc định (đỡ chóng mặt)
                    "orientationOnByDefault": false,
                    "compass": false
                },
                "scenes": {
@{
    for (int i = 0; i < sceneList.Count; i++)
    {
        var s = sceneList[i];
        var title = s.Translations
                     ?.FirstOrDefault(t => t.LangCode == lang)?.Title
                     ?? s.Title;
        var hotspots = s.Hotspots.ToList();
    @:                    "@s.SceneKey": {
    @:                        "title": "@HttpUtility.JavaScriptStringEncode(title)",
    @:                        "panorama": "@Url.Content(s.PanoramaUrl)",
    @:                        "hfov": @s.Hfov.ToString(System.Globalization.CultureInfo.InvariantCulture),
    @:                        "pitch": @s.Pitch.ToString(System.Globalization.CultureInfo.InvariantCulture),
    @:                        "yaw": @s.Yaw.ToString(System.Globalization.CultureInfo.InvariantCulture),
    @:                        "hotSpots": [
        for (int j = 0; j < hotspots.Count; j++)
        {
            var h = hotspots[j];
            var ht = h.Translations
                      ?.FirstOrDefault(t => t.LangCode == lang)?.Text
                      ?? h.Text;
    @:                            {
    @:                                "pitch": @h.Pitch.ToString(System.Globalization.CultureInfo.InvariantCulture),
    @:                                "yaw": @h.Yaw.ToString(System.Globalization.CultureInfo.InvariantCulture),
    @:                                "type": "info",
    @:                                "text": "@HttpUtility.JavaScriptStringEncode(ht)",
    @:                                "cssClass": "footspot",
    @:                                "clickHandlerFunc": walkToScene,
    @:                                "clickHandlerArgs": { "sceneId": "@h.TargetSceneKey" }
    @:                            }@(j < hotspots.Count - 1 ? "," : "")
        }
    @:                        ]
    @:                    }@(i < sceneList.Count - 1 ? "," : "")
    }
}
                }
            };

            function validateConfig(cfg) {
                if (!cfg || typeof cfg !== 'object') throw new Error('Config VR không hợp lệ');
                if (!cfg.scenes || Object.keys(cfg.scenes).length === 0) throw new Error('Config VR không có scene nào');

                var first = cfg.default && cfg.default.firstScene;
                if (!first || !cfg.scenes[first]) {
                    var keys = Object.keys(cfg.scenes);
                    cfg.default = cfg.default || {};
                    cfg.default.firstScene = keys[0];
                    console.warn('[VR] firstScene không hợp lệ, auto chọn: ' + keys[0]);
                }
                return cfg;
            }

            function updateMinimapActive(sceneId) {
                var rooms = document.querySelectorAll('.minimap-room');
                rooms.forEach(function (el) {
                    if (el.getAttribute('data-scene') === sceneId) el.classList.add('active');
                    else el.classList.remove('active');
                });
            }

            function initUiEvents() {
                document.querySelectorAll('.minimap-room').forEach(function (el) {
                    el.addEventListener('click', function () {
                        var sceneId = el.getAttribute('data-scene');
                        walkToScene(null, { sceneId: sceneId });
                    });
                });

                var btn = document.getElementById('hotspot-mode-btn');
                var coordsPanel = getCoordsPanel();

                if (btn) {
                    btn.addEventListener('click', function () {
                        hotspotMode = !hotspotMode;
                        if (hotspotMode) {
                            btn.classList.add('on');
                            btn.textContent = 'Chế độ tạo hotspot: ON';
                        } else {
                            btn.classList.remove('on');
                            btn.textContent = 'Chế độ tạo hotspot: OFF';
                            if (coordsPanel && viewer) {
                                coordsPanel.textContent = 'Scene: ' + viewer.getScene() + ' | pitch: - | yaw: -';
                            }
                        }
                    });
                }

                // lấy pitch/yaw khi click
                if (viewer) {
                    viewer.on('mousedown', function (event) {
                        try {
                            if (!hotspotMode) return;
                            var coords = viewer.mouseEventToCoords(event);
                            if (!coords) return;

                            var pitch = coords[0].toFixed(2);
                            var yaw = coords[1].toFixed(2);
                            var sceneId = viewer.getScene();

                            var text = 'Scene: ' + sceneId + ' | pitch: ' + pitch + ' | yaw: ' + yaw + '  (copy để lưu DB)';
                            var panel = getCoordsPanel();
                            if (panel) panel.textContent = text;
                            console.log(text);
                        } catch (err) {
                            logError('Lỗi khi lấy pitch/yaw', err);
                        }
                    });
                }

                // nút auto run
                var autorunBtn = document.getElementById('autorun-btn');
                if (autorunBtn) {
                    autorunBtn.addEventListener('click', function () {
                        try {
                            autorunOn = !autorunOn;
                            if (!viewer) {
                                autorunOn = false;
                                logError('Không thể bật AutoRun vì viewer chưa sẵn sàng');
                                return;
                            }

                            if (autorunOn) {
                                // OPT: mobile quay cực chậm
                                viewer.startAutoRotate(isMobile ? -0.25 : -1.2);
                                autorunBtn.classList.add('on');
                                autorunBtn.textContent = 'Tự chạy: ON';
                            } else {
                                viewer.stopAutoRotate();
                                autorunBtn.classList.remove('on');
                                autorunBtn.textContent = 'Tự chạy: OFF';
                            }
                        } catch (err) {
                            logError('Lỗi khi bật/tắt AutoRun', err);
                        }
                    });
                }
            }

            function registerViewerEvents() {
                if (!viewer) return;

                viewer.on('scenechange', function (sceneId) {
                    try {
                        updateMinimapActive(sceneId);
                        showUserMessage('Scene: ' + sceneId + ' | pitch: - | yaw: -');
                        // OPT: sau đổi scene, upscale lại canvas để nét
                        setTimeout(upscaleCanvas, 90);
                    } catch (err) {
                        logError('Lỗi trong scenechange', err);
                    }
                });

                viewer.on('load', function () {
                    // OPT: lúc load xong, upscale nét
                    setTimeout(upscaleCanvas, 80);
                });

                viewer.on('error', function (e) {
                    logError('Pannellum error event', e);
                });

                viewer.on('loadfail', function (e) {
                    logError('Không tải được ảnh VR (loadfail)', e);
                });
            }

            function initViewer() {
                try {
                    var container = document.getElementById('vr');
                    if (!container) throw new Error('Không tìm thấy #vr');

                    var safeConfig = validateConfig(config);
                    viewer = pannellum.viewer('vr', safeConfig);

                    registerViewerEvents();
                    initUiEvents();

                    updateMinimapActive(viewer.getScene());

                    // OPT: lần đầu upscale
                    setTimeout(upscaleCanvas, 120);
                } catch (err) {
                    logError('Khởi tạo VR thất bại', err);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initViewer);
            } else {
                initViewer();
            }
        })();
    </script>
</body>
</html>
