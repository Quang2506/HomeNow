@using HomeNow.Resources
@model Core.Models.HomeIndexViewModel

@{
    ViewBag.Title = "Home - NhàNow";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var currentLang = System.Threading.Thread.CurrentThread.CurrentUICulture.Name;
    var totalListings = 182;
    var currentType = Model.HasSearch
    ? (string.IsNullOrEmpty(Model.TransactionType) ? "rent" : Model.TransactionType)
    : "";    


    var results = Model.SearchResults ?? new List<Core.Models.PropertyListItemViewModel>();
    var featuredRent = Model.FeaturedRent ?? new List<Core.Models.PropertyListItemViewModel>();
    var featuredSale = Model.FeaturedSale ?? new List<Core.Models.PropertyListItemViewModel>();
}

@helper RenderPropertyCard(Core.Models.PropertyListItemViewModel item)
{
    <div class="property-card">
        <img src="@item.ThumbnailUrl" alt="@item.Title" />
        <div class="property-card-body">
            <div class="property-card-title">@item.Title</div>
            <div class="property-card-address">@item.Address</div>
            <div class="property-card-meta">
                <span>@item.Bed PN · @item.Bath WC</span>
                <span>@item.Area m²</span>
            </div>
            <div class="property-card-price">@item.PriceLabel</div>
        </div>
    </div>
}

<link rel="stylesheet" href="~/Content/style/Home/index.css" />

<style>
    /* 4 căn / dòng desktop, 2 căn / dòng tablet & mobile */
    .property-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        grid-gap: 24px;
    }

    @@media (max-width: 991px) {
        .property-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .pagination {
        display: flex;
        list-style: none;
        padding-left: 0;
        margin-top: 24px;
        justify-content: center;
    }

        .pagination li {
            margin: 0 4px;
        }

        .pagination a,
        .pagination span {
            display: block;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
            text-decoration: none;
            color: #333;
            background-color: #fff;
        }

        .pagination .active span {
            background-color: #16a34a;
            border-color: #16a34a;
            color: #fff;
        }

        .pagination .disabled span {
            color: #aaa;
            background-color: #f5f5f5;
        }
</style>

<div class="home-hero" style="background-image:url('@(ViewBag.HeroBackground ?? "/Assets/Banner.jpg")');">
    <div class="home-hero-shell">
        <!-- HEADER -->
        <div class="home-hero-header">
            <!-- Logo + city -->
            <a href=@Url.Action("index", "Home") class="home-header-left-box">
                <div class="home-logo-icon"></div>
                <div class="home-header-left">
                    <div class="home-header-left-top">
                        <span>NhàNow</span>
                    </div>
                    <div class="home-header-left-tagline">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 2.5C8.96 2.5 6.5 4.96 6.5 8c0 3.74 3.39 7.47 4.96 9.15.29.31.77.31 1.06 0C14.11 15.47 17.5 11.74 17.5 8c0-3.04-2.46-5.5-5.5-5.5zm0 6.5A2 2 0 1 1 12 5a2 2 0 0 1 0 4z" />
                        </svg>
                        @HomeTexts.CityName
                    </div>
                </div>
            </a>

            <!-- Menu phải -->
            <div class="home-header-right-box">
                <div class="home-header-right-top">
                    @if (User.Identity.IsAuthenticated)
                    {
                        var name = Session["CurrentUserName"] as string ?? "Tài khoản";

                        <a href="@Url.Action("Favorites", "Property")" class="hidden-xs">
                            <i class="fa-solid fa-heart"></i>
                        </a>
                        <span class="hidden-xs">
                            <i class="fa-solid fa-user"></i> @name
                        </span>
                        <a href="@Url.Action("Logout", "Account")" class="hidden-xs">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </a>
                    }
                    else
                    {
                        <a href="@Url.Action("Favorites", "Property")" class="hidden-xs">
                            <i class="fa-solid fa-heart"></i>
                        </a>
                        <a href="javascript:void(0)" class="hidden-xs js-open-login">Đăng nhập</a>
                    }

                    <a href="@Url.Action("Request", "Landlord")" class="nav-post">
                        @HomeTexts.Menu_Post
                    </a>
                </div>

                <div class="home-header-right-bottom">
                    <a href="@Url.Action("Set", "Language", new { lang = "vi-VN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("vi") ? "lang-active" : "")">
                        VI
                    </a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "en-US", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("en") ? "lang-active" : "")">
                        EN
                    </a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "zh-CN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("zh") ? "lang-active" : "")">
                        中文
                    </a>
                </div>
            </div>
        </div>

        <!-- MAIN + SEARCH -->
        <div class="home-hero-main">
            <div class="home-main-text">
                <div class="home-main-title">
                    @HomeTexts.MainTitle
                </div>
                <div class="home-sub-title">
                    @string.Format(HomeTexts.SubTitle, totalListings)
                </div>
            </div>

            <div class="home-main-search">
                @using (Html.BeginForm("Index", "Home", FormMethod.Get, new { @class = "home-search-form" }))
                {
                    <div class="home-search-wrapper">
                        <!-- HÀNG TRÊN: Thuê/Mua + ô nhập + nút kính lúp -->
                        <div class="home-search-top">
                            <div class="home-search-tabs">
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "rent" ? "active" : "")"
                                        data-value="rent">
                                    Thuê nhà
                                </button>
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "sale" ? "active" : "")"
                                        data-value="sale">
                                    Mua nhà
                                </button>
                            </div>

                            <div class="home-search-input-wrap">
                                <input type="text"
                                       name="keyword"
                                       value="@Model.Keyword"
                                       placeholder="Nhập vị trí chi tiết: đường, xã, phường..." />
                            </div>

                            <button type="submit" class="home-search-btn-main">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </div>

                        <!-- giữ transactionType -->
                        <input type="hidden"
                               name="transactionType"
                               id="transactionTypeInput"
                               value="@currentType" />

                        <!-- HÀNG DƯỚI: Thành phố / Mốc giá / Loại nhà -->
                        <div class="home-search-bottom">
                            <!-- THÀNH PHỐ -->
                            <div class="home-search-filter">
                                <select id="citySelect" name="cityId" class="home-search-filter-select">
                                    <option value="">Thành phố</option>
                                    @if (Model.Cities != null)
                                    {
                                        foreach (var c in Model.Cities)
                                        {
                                            <option value="@c.CityId"
                                                    data-bg="@c.BackgroundUrl"
                                                    @(Model.CityId == c.CityId ? "selected" : "")>
                                                @c.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- MỐC GIÁ -->
                            <div class="home-search-filter">
                                <select name="priceRange" class="home-search-filter-select">
                                    <option value="">Mốc giá</option>
                                    @if (Model.PriceFilters != null)
                                    {
                                        foreach (var pf in Model.PriceFilters)
                                        {
                                            <option value="@pf.Code"
                                                    @(Model.PriceRange == pf.Code ? "selected" : "")>
                                                @pf.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- LOẠI NHÀ -->
                            <div class="home-search-filter">
                                <select name="propertyType" class="home-search-filter-select">
                                    <option value="">Loại nhà</option>
                                    @if (Model.PropertyTypes != null)
                                    {
                                        foreach (var pt in Model.PropertyTypes)
                                        {
                                            <option value="@pt.Code"
                                                    @(Model.PropertyType == pt.Code ? "selected" : "")>
                                                @pt.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="home-body-container">
    @if (Model.HasSearch)
    {
        <div class="home-section-header">
            <h2>Kết quả tìm kiếm</h2>
        </div>

        if (results.Any())
        {
            <div class="property-grid">
                @foreach (var item in results)
                {
                    @RenderPropertyCard(item)
                }
            </div>

            @* PHÂN TRANG *@
            if (Model.TotalPages > 1)
            {
                <ul class="pagination">
                    <!-- Prev -->
                    <li class="@(Model.Page <= 1 ? "disabled" : "")">
                        @if (Model.Page <= 1)
                        {
                            <span>&laquo;</span>
                        }
                        else
                        {
                            <a href="@Url.Action("Index", new {
                                page           = Model.Page - 1,
                                transactionType = Model.TransactionType,
                                cityId          = Model.CityId,
                                priceRange      = Model.PriceRange,
                                propertyType    = Model.PropertyType,
                                keyword         = Model.Keyword
                            })">&laquo;</a>
                        }
                    </li>

                    <!-- Pages -->
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="@(i == Model.Page ? "active" : "")">
                            @if (i == Model.Page)
                            {
                                <span>@i</span>
                            }
                            else
                            {
                                <a href="@Url.Action("Index", new {
                                    page           = i,
                                    transactionType = Model.TransactionType,
                                    cityId          = Model.CityId,
                                    priceRange      = Model.PriceRange,
                                    propertyType    = Model.PropertyType,
                                    keyword         = Model.Keyword
                                })">@i</a>
                            }
                        </li>
                    }

                    <!-- Next -->
                    <li class="@(Model.Page >= Model.TotalPages ? "disabled" : "")">
                        @if (Model.Page >= Model.TotalPages)
                        {
                            <span>&raquo;</span>
                        }
                        else
                        {
                            <a href="@Url.Action("Index", new {
                                page           = Model.Page + 1,
                                transactionType = Model.TransactionType,
                                cityId          = Model.CityId,
                                priceRange      = Model.PriceRange,
                                propertyType    = Model.PropertyType,
                                keyword         = Model.Keyword
                            })">&raquo;</a>
                        }
                    </li>
                </ul>
            }
        }
        else
        {
            <p>Không tìm thấy căn phù hợp, bạn thử thay đổi điều kiện tìm kiếm nhé.</p>
        }
    }
    else
    {
        <!-- Các căn cho thuê nổi bật -->
        <section style="margin-bottom:24px;">
            <div class="home-section-header">
                <h2>Các căn cho thuê nổi bật</h2>
                <a href="@Url.Action("List", "Property", new { mode = "rent" })">xem thêm</a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredRent)
                {
                    @RenderPropertyCard(item)
                }
            </div>
        </section>

        <!-- Các căn bán nổi bật -->
        <section>
            <div class="home-section-header">
                <h2>Các căn bán nổi bật</h2>
                <a href="@Url.Action("List", "Property", new { mode = "sale" })">xem thêm</a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredSale)
                {
                    @RenderPropertyCard(item)
                }
            </div>
        </section>
    }
</div>

@section Scripts {
    <script>
        // Toggle Thuê / Mua
        (function () {
            var buttons = document.querySelectorAll(".home-search-tab-btn");
            var hiddenInput = document.getElementById("transactionTypeInput");

            buttons.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var val = this.getAttribute("data-value");
                    hiddenInput.value = val;

                    buttons.forEach(function (b) { b.classList.remove("active"); });
                    this.classList.add("active");
                });
            });
        })();

        // Đổi background theo thành phố
        (function () {
            var hero = document.querySelector(".home-hero");
            var citySelect = document.getElementById("citySelect");
            if (!hero || !citySelect) return;

            function applyCityBackground() {
                var opt = citySelect.options[citySelect.selectedIndex];
                if (!opt) return;

                var bg = opt.getAttribute("data-bg");
                if (bg && bg.length > 0) {
                    hero.style.backgroundImage = "url('" + bg + "')";
                } else {
                    hero.style.backgroundImage = "";
                }
            }

            citySelect.addEventListener("change", applyCityBackground);
            applyCityBackground();
        })();
    </script>
}
