@using HomeNow.Resources
@using Core.Models
@using Core.ViewModels
@using System.Web

@model HomeIndexViewModel

@{
    ViewBag.Title = HomeTexts.PageTitle_Home;

    var currentLang = System.Threading.Thread.CurrentThread.CurrentUICulture.Name;
    var totalListings = ViewBag.TotalListings ?? 0;

    var results = Model.SearchResults ?? new List<PropertyListItemViewModel>();
    var featuredRent = Model.FeaturedRent ?? new List<PropertyListItemViewModel>();
    var featuredSale = Model.FeaturedSale ?? new List<PropertyListItemViewModel>();

    string currentType;
    if (Model.HasSearch)
    {
        currentType = string.IsNullOrEmpty(Model.TransactionType) ? "rent" : Model.TransactionType;
    }
    else
    {
        currentType = "";
    }

    var JS_FavNeedLogin = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_NeedLogin);
    var JS_FavUpdateFail = HttpUtility.JavaScriptStringEncode(HomeTexts.Favorite_UpdateFailed);


    var favCount = (int)(ViewBag.FavoriteCount ?? 0);
    var favCountText = favCount > 99 ? "99+" : favCount.ToString();
}

@helper RenderPropertyCard(Core.Models.PropertyListItemViewModel item)
{
    <div class="property-card">
        <div class="property-card-fav js-fav-toggle @(item.IsFavorite ? "is-fav" : "")"
             data-id="@item.PropertyId">
            <i class="fa-solid fa-heart"></i>
        </div>

        <img src="@item.ThumbnailUrl" alt="@item.Title" />
        <div class="property-card-body">
            <div class="property-card-title">@item.Title</div>
            <div class="property-card-address"><i class="fa-solid fa-location-dot"></i>@item.Address</div>
            <div class="property-card-meta">
                <span>
                    <i class="fa-solid fa-bed"></i>
                    @(item.Bed ?? 0)@HomeTexts.Unit_Bedroom <i class="fa-solid fa-bath"></i> @(item.Bath ?? 0) @HomeTexts.Unit_Bathroom
                </span>
                <span><i class="fa-solid fa-ruler-combined"></i>@item.Area m²</span>
            </div>
            <div class="property-card-price">
                <i class="fa-solid fa-sack-dollar"></i>
                @item.PriceLabel @HomeTexts.Currency_VND
            </div>
        </div>
    </div>
}

<head>
    <link rel="stylesheet" href="~/Content/font-awesome/all.min.css">
    <link rel="stylesheet" href="~/Content/style/Home/index.css" />

    <style>
       
        .fav-wrap.has-badge i {
            color: #ff4d6d;
        }

        .fav-badge {
            position: absolute;
            top: -4px;
            right: -6px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 999px;
            background: #22c55e; 
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .home-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .home-section-more {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: #0f172a;
            color: #fff !important;
            text-decoration: none;
            font-size: 13px;
            white-space: nowrap;
            opacity: .92;
        }

            .home-section-more:hover {
                opacity: 1;
                transform: translateY(-1px);
            }

        .fa-angles-up {
            color: #aaa
        }

        .home-header-right-top .nav-post {
            background: #00B1FE;
        }

        .account-hover {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 14px;
        }

        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            min-width: 160px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,.25);
            overflow: hidden;
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: opacity .15s ease, transform .15s ease;
            z-index: 99999;
        }

            .account-dropdown::before {
                content: "";
                position: absolute;
                top: -12px;
                left: 0;
                right: 0;
                height: 12px;
            }

        .account-hover:hover .account-dropdown,
        .account-hover.open .account-dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .account-dropdown a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            white-space: nowrap;
        }

            .account-dropdown a:hover {
                background: rgba(255,255,255,.08);
            }

        .scroll-top-btn {
            position: fixed;
            right: 40px;
            bottom: 40px;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            cursor: pointer;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

            .scroll-top-btn i {
                font-size: 16px;
            }

            .scroll-top-btn.show {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(0);
            }

        a {
            color: snow;
            text-decoration: none
        }

        .property-card {
            position: relative;
        }

        .property-card-fav {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

            .property-card-fav i {
                font-size: 14px;
                color: #fff;
            }

            .property-card-fav:hover {
                transform: scale(1.05);
            }

            .property-card-fav.is-fav {
                background: #ef4444;
            }

                .property-card-fav.is-fav i {
                    color: #fff;
                }

        .home-search-filter-select {
            padding-left: 7px;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-gap: 24px;
        }

        @@media (max-width: 991px) {
            .property-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @@media(min-width:500px) {
            .account-trigger {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                color: #fff;
                padding: 6px 10px;
                border-radius: 999px;
                background: rgba(15, 23, 42, 0.35);
                user-select: none;
            }

                .account-trigger:hover {
                    background: rgba(15, 23, 42, 0.55);
                }
        }

        @@media(max-width:500px) {
            .account-dropdown a {
                gap: 10px;
                padding: 4px 2px;
            }

            .account-dropdown {
                position: absolute;
                top: 68%;
                right: -50px;
                margin-top: 0px;
                min-width: 101px;
                background: rgba(15, 23, 42, 0.95);
                border-radius: 12px;
                box-shadow: none;
                opacity: 0;
                transform: translateY(-6px);
                pointer-events: none;
                transition: opacity .15s ease, transform .15s ease;
                z-index: 99999;
            }

            .home-hero-header {
                margin-bottom: 0px;
            }

            .home-header-right-top {
                margin-bottom: 0rem;
            }

            .account-trigger {
                cursor: pointer;
                color: #fff;
                border-radius: 999px;
                user-select: none;
            }
            .home-header-right-top a {
                margin:0px
            }
            .fav-badge {
              
                top: -1px;
                right: -6px;
                min-width: 15px;
                height: 15px;
             
                
            }
        }

        /* ===========================*/
        .fav-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 999px;
        }

           
    </style>
</head>

<div class="home-hero" style="background-image:url('@(ViewBag.HeroBackground ?? "/Assets/Banner.jpg")');">
    <div class="home-hero-shell">
        <div class="home-hero-header">
            <a href=@Url.Action("Index", "Home") class="home-header-left-box">
                <div class="home-logo-icon"></div>
                <div class="home-header-left">
                    <div class="home-header-left-top"><span>NhàNow</span></div>
                    <div class="home-header-left-tagline">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 2.5C8.96 2.5 6.5 4.96 6.5 8c0 3.74 3.39 7.47 4.96 9.15.29.31.77.31 1.06 0C14.11 15.47 17.5 11.74 17.5 8c0-3.04-2.46-5.5-5.5-5.5zm0 6.5A2 2 0 1 1 12 5a2 2 0 0 1 0 4z" />
                        </svg>
                        @HomeTexts.CityName
                    </div>
                </div>
            </a>

            <div class="home-header-right-box">
                <div class="home-header-right-top">
                    @if (User.Identity.IsAuthenticated)
                    {
                        var name = Session["CurrentUserName"] as string ?? HomeTexts.Account_Default;

                        @*  Heart header có badge *@
                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top fav-wrap @(favCount > 0 ? "has-badge" : "")"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                            @if (favCount > 0)
                            {
                                <span id="headerFavBadge" class="fav-badge">@favCountText</span>
                            }
                        </a>

                        <a class="hidden-xs" href="javascript:void(0)">
                            <i class="fa-solid fa-bell"></i>
                        </a>

                        <div class="hidden-xs account-hover">
                            <div class="account-trigger">
                                <i class="fa-solid fa-user"></i>
                                <span>@name</span>
                                <i class="fa-solid fa-caret-down" style="font-size:12px; opacity:.8;"></i>
                            </div>

                            <div class="account-dropdown">
                                <a href="@Url.Action("Logout", "Account")">
                                    <i class="fa-solid fa-right-from-bracket"></i> @HomeTexts.Logout
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top fav-wrap"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                        </a>

                        <a class="hidden-xs" href="javascript:void(0)">
                            <i class="fa-solid fa-bell"></i>
                        </a>

                        <a href="javascript:void(0)" class="hidden-xs js-open-login">@HomeTexts.Login</a>
                    }

                    <a href="@Url.Action("Request", "Landlord")" class="nav-post">
                        @HomeTexts.Menu_Post
                    </a>
                </div>

                <div class="home-header-right-bottom">
                    <a href="@Url.Action("Set", "Language", new { lang = "vi-VN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("vi") ? "lang-active" : "")">VI</a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "en-US", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("en") ? "lang-active" : "")">EN</a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "zh-CN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("zh") ? "lang-active" : "")">中文</a>
                </div>
            </div>
        </div>

        <div class="home-hero-main">
            <div class="home-main-text">
                <div class="home-main-title">@HomeTexts.MainTitle</div>
                <div class="home-sub-title">@string.Format(HomeTexts.SubTitle, totalListings)</div>
            </div>

            <div class="home-main-search">
                @using (Html.BeginForm("Index", "Home", FormMethod.Get, new { @class = "home-search-form" }))
                {
                    <div class="home-search-wrapper">
                        <div class="home-search-top">
                            <div class="home-search-tabs">
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "rent" ? "active" : "")"
                                        data-value="rent">
                                    @HomeTexts.Tab_Rent
                                </button>
                                <span style="color:#aaa">|</span>
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "sale" ? "active" : "")"
                                        data-value="sale">
                                    @HomeTexts.Tab_Sale
                                </button>
                            </div>

                            <div class="home-search-input-wrap">
                                <input type="text" name="keyword" value="@Model.Keyword" placeholder="@HomeTexts.Search_Placeholder" />
                            </div>

                            <button type="submit" class="home-search-btn-main">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </div>

                        <input type="hidden" name="transactionType" id="transactionTypeInput" value="@currentType" />

                        <div class="home-search-bottom">
                            <div class="home-search-filter">
                                <select id="citySelect" name="cityId" class="home-search-filter-select">
                                    <option value="">@HomeTexts.Filter_City</option>
                                    @if (Model.Cities != null)
                                    {
                                        foreach (var c in Model.Cities)
                                        {
                                            <option value="@c.CityId"
                                                    data-bg="@c.BackgroundUrl"
                                                    @(Model.CityId == c.CityId ? "selected" : "")>
                                                @c.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="home-search-filter">
                                <select name="priceRange" class="home-search-filter-select">
                                    <option value="">@HomeTexts.Filter_Price</option>
                                    @if (Model.PriceFilters != null)
                                    {
                                        foreach (var pf in Model.PriceFilters)
                                        {
                                            <option value="@pf.Code" @(Model.PriceRange == pf.Code ? "selected" : "")>@pf.Name</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="home-search-filter">
                                <select name="propertyType" class="home-search-filter-select">
                                    <option value="">@HomeTexts.Filter_PropertyType</option>
                                    @if (Model.PropertyTypes != null)
                                    {
                                        foreach (var pt in Model.PropertyTypes)
                                        {
                                            <option value="@pt.Code" @(Model.PropertyType == pt.Code ? "selected" : "")>@pt.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="home-body-container">
    @if (Model.HasSearch)
    {
        <div class="home-section-header">
            <h2>@HomeTexts.SearchResult_Title</h2>
        </div>

        if (results.Any())
        {
            <div id="search-results" class="property-grid">
                @Html.Partial("_PropertyCardList", results)
            </div>

            <input type="hidden" id="currentPage" value="@Model.Page" />
            <input type="hidden" id="totalPages" value="@Model.TotalPages" />
            <div id="load-more-sentinel" style="height: 1px;"></div>
        }
        else
        {
            <p>@HomeTexts.Search_NotFound</p>
        }
    }
    else
    {
        <section style="margin-bottom:24px;">
            <div class="home-section-header">
                <h2>@HomeTexts.FeaturedRent_Title</h2>
                <a class="home-section-more" href="@Url.Action("List", "Property", new { mode = "rent" })">
                    @HomeTexts.ViewMore <i class="fa-solid fa-angle-right"></i>
                </a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredRent)
                {@RenderPropertyCard(item)}
            </div>
        </section>

        <section>
            <div class="home-section-header">
                <h2>@HomeTexts.FeaturedSale_Title</h2>
                <a class="home-section-more" href="@Url.Action("List", "Property", new { mode = "sale" })">
                    @HomeTexts.ViewMore <i class="fa-solid fa-angle-right"></i>
                </a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredSale)
                {@RenderPropertyCard(item)}
            </div>
        </section>
    }
</div>

<div href="#" id="scrollTopBtn" class="scroll-top-btn">
    <i class="fa-solid fa-angles-up"></i>
</div>

@section Scripts {
    <script>
        (function () {
            var buttons = document.querySelectorAll(".home-search-tab-btn");
            var hiddenInput = document.getElementById("transactionTypeInput");

            buttons.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var val = this.getAttribute("data-value");
                    hiddenInput.value = val;
                    buttons.forEach(function (b) { b.classList.remove("active"); });
                    this.classList.add("active");
                });
            });
        })();

        (function () {
            var hero = document.querySelector(".home-hero");
            var citySelect = document.getElementById("citySelect");
            if (!hero || !citySelect) return;

            function applyCityBackground() {
                var opt = citySelect.options[citySelect.selectedIndex];
                if (!opt) return;

                var bg = opt.getAttribute("data-bg");
                if (bg && bg.length > 0) hero.style.backgroundImage = "url('" + bg + "')";
                else hero.style.backgroundImage = "";
            }

            citySelect.addEventListener("change", applyCityBackground);
            applyCityBackground();
        })();


        //  HEADER FAVORITES BADGE


        // trạng thái auth có thể thay đổi sau login modal -> dùng biến global
        window.__isAuth = @User.Identity.IsAuthenticated.ToString().ToLower();

        function updateHeaderFavBadge(count) {
            count = parseInt(count || 0, 10);

            var $wrap = $('.js-fav-top.fav-wrap');
            if ($wrap.length === 0) return;

            var $badge = $('#headerFavBadge');

            if (count > 0) {
                var text = count > 99 ? '99+' : String(count);
                $wrap.addClass('has-badge');

                if ($badge.length === 0) {
                    $wrap.append('<span id="headerFavBadge" class="fav-badge">' + text + '</span>');
                } else {
                    $badge.text(text);
                }
            } else {
                $wrap.removeClass('has-badge');
                if ($badge.length) $badge.remove();
            }
        }

        //  gọi server lấy count + auth để cập nhật theo thời gian thực
        window.refreshHeaderFav = function () {
            return $.get('@Url.Action("HeaderFavoriteInfo", "Property")')
                .done(function (res) {
                    if (!res) return;
                    window.__isAuth = !!res.isAuth;
                    updateHeaderFavBadge(res.favoriteCount || 0);
                });
        };

        //  tự sync khi load trang + khi quay lại tab
        $(function () {
            window.refreshHeaderFav();

            document.addEventListener('visibilitychange', function () {
                if (!document.hidden) window.refreshHeaderFav();
            });
        });

        //  bạn có thể gọi event này sau khi login modal thành công
        window.addEventListener('auth:changed', function () {
            window.refreshHeaderFav();
        });


        //  Toggle Favorite (update badge realtime)

        (function () {
            var MSG_NEED_LOGIN = '@JS_FavNeedLogin';
            var MSG_UPDATE_FAIL = '@JS_FavUpdateFail';

            $(document).on('click', '.js-fav-toggle', function (e) {
                e.preventDefault();

                var $btn = $(this);
                var propertyId = $btn.data('id');

                $.ajax({
                    url: '@Url.Action("ToggleFavorite", "Property")',
                    type: 'POST',
                    data: { propertyId: propertyId },
                    success: function (res) {
                        if (!res) return;

                        if (res.needLogin) {
                            if (window.loginModal && typeof window.loginModal.open === 'function') {
                                window.loginModal.open(window.location.pathname + window.location.search);
                            } else {
                                alert(MSG_NEED_LOGIN);
                            }
                            return;
                        }

                        if (res.success) {
                            if (res.isFavorite) $btn.addClass('is-fav');
                            else $btn.removeClass('is-fav');

                            //  luôn sync lại count ở header (không phụ thuộc res.favoriteCount)
                            window.refreshHeaderFav();
                        }
                    },
                    error: function () { alert(MSG_UPDATE_FAIL); }
                });
            });
        })();


        // Infinite Scroll search

        (function () {
            var $results = $('#search-results');
            if ($results.length === 0) return;

            var currentPage = parseInt($('#currentPage').val() || '1', 10);
            var totalPages = parseInt($('#totalPages').val() || '1', 10);
            var isLoading = false;

            var filters = {
                transactionType: '@(Model.TransactionType ?? "")',
                cityId: '@(Model.CityId.HasValue ? Model.CityId.ToString() : "")',
                priceRange: '@(Model.PriceRange ?? "")',
                propertyType: '@(Model.PropertyType ?? "")',
                keyword: '@(Model.Keyword ?? "")'
            };

            function loadNextPage() {
                if (isLoading) return;
                if (currentPage >= totalPages) return;

                isLoading = true;
                currentPage++;

                var data = $.extend({}, filters, { page: currentPage });

                $.get('@Url.Action("LoadMore", "Home")', data)
                    .done(function (html) {
                        if (html && $.trim(html).length > 0) {
                            $results.append(html);
                            $('#currentPage').val(currentPage);
                        } else {
                            currentPage = totalPages;
                        }
                    })
                    .always(function () { isLoading = false; });
            }

            var sentinel = document.getElementById('load-more-sentinel');
            if ('IntersectionObserver' in window && sentinel) {
                var io = new IntersectionObserver(function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) loadNextPage();
                    });
                }, { root: null, rootMargin: '0px 0px 200px 0px', threshold: 0 });

                io.observe(sentinel);
            } else {
                $(window).on('scroll', function () {
                    if ($(window).scrollTop() + $(window).height() + 200 >= $(document).height()) {
                        loadNextPage();
                    }
                });
            }
        })();


        // Scroll top

        (function () {
            var $btn = $('#scrollTopBtn');
            if ($btn.length === 0) return;

            $(window).on('scroll', function () {
                if ($(this).scrollTop() > window.innerHeight) $btn.addClass('show');
                else $btn.removeClass('show');
            });

            $btn.on('click', function (e) {
                e.preventDefault();
                $('html, body').animate({ scrollTop: 0 }, 400);
            });
        })();


        // Account dropdown hover

        (function () {
            var menu = document.querySelector('.account-hover');
            if (!menu) return;

            var timer = null;

            menu.addEventListener('mouseenter', function () {
                if (timer) clearTimeout(timer);
                menu.classList.add('open');
            });

            menu.addEventListener('mouseleave', function () {
                timer = setTimeout(function () { menu.classList.remove('open'); }, 200);
            });
        })();


        // Favorites header click: check login realtime

        (function () {
            $(document).on('click', '.js-fav-top', function (e) {
                if (window.__isAuth) return; // ✅ login rồi thì cho đi bình thường

                e.preventDefault();

                var returnUrl = $(this).data('return') || (window.location.pathname + window.location.search);

                if (window.loginModal && typeof window.loginModal.open === 'function') {
                    window.loginModal.open(returnUrl);
                } else {
                    window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent(returnUrl);
                }
            });
        })();
    </script>
}

