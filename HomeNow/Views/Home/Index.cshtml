@using HomeNow.Resources
@using Core.Models
@using Core.ViewModels

@model HomeIndexViewModel

@{
    ViewBag.Title = "NhàNow - Tìm nhà dễ dàng";

    var currentLang = System.Threading.Thread.CurrentThread.CurrentUICulture.Name;
    var totalListings = ViewBag.TotalListings ?? 0;

    var results = Model.SearchResults ?? new List<PropertyListItemViewModel>();
    var featuredRent = Model.FeaturedRent ?? new List<PropertyListItemViewModel>();
    var featuredSale = Model.FeaturedSale ?? new List<PropertyListItemViewModel>();

    // === CHỈ set active khi đang search ===
    string currentType;
    if (Model.HasSearch)
    {
        currentType = string.IsNullOrEmpty(Model.TransactionType)
            ? "rent"               // đang search mà không truyền, default = rent
            : Model.TransactionType;
    }
    else
    {
        currentType = "";           // đang ở trang nổi bật -> không nút nào được chọn
    }
}

@helper RenderPropertyCard(Core.Models.PropertyListItemViewModel item)
{
    <div class="property-card">
        <div class="property-card-fav js-fav-toggle @(item.IsFavorite ? "is-fav" : "")"
             data-id="@item.PropertyId">
            <i class="fa-solid fa-heart"></i>
        </div>

        <img src="@item.ThumbnailUrl" alt="@item.Title" />
        <div class="property-card-body">
            <div class="property-card-title">@item.Title</div>
            <div class="property-card-address">@item.Address</div>
            <div class="property-card-meta">
                <span>@(item.Bed ?? 0) PN · @(item.Bath ?? 0) WC</span>
                <span>@item.Area m²</span>
            </div>
            <div class="property-card-price">
                @item.PriceLabel VND
            </div>
        </div>
    </div>
}

<head>
    <link rel="stylesheet" href="~/Content/font-awesome/all.min.css">
    <link rel="stylesheet" href="~/Content/style/Home/index.css" />

    <style>
        .fa-angles-up{
            color:#aaa
        }
        .home-header-right-top .nav-post {
            background: #00B1FE;
        }
        /* ===== Account hover dropdown (FIX hover gap) ===== */
        .account-hover {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            /* tạo vùng hover “dài” xuống dưới để không rớt hover */
            padding-bottom: 14px;
        }

       

        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            min-width: 160px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,.25);
            overflow: hidden;
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: opacity .15s ease, transform .15s ease;
            z-index: 99999;
        }

            /* “cầu nối” vô hình để rê chuột từ trigger xuống dropdown không bị mất */
            .account-dropdown::before {
                content: "";
                position: absolute;
                top: -12px;
                left: 0;
                right: 0;
                height: 12px;
            }

        /* mở bằng hover hoặc bằng class open (JS) */
        .account-hover:hover .account-dropdown,
        .account-hover.open .account-dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .account-dropdown a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            white-space: nowrap;
        }

            .account-dropdown a:hover {
                background: rgba(255,255,255,.08);
            }


        .scroll-top-btn {
            position: fixed;
            right: 40px;
            bottom: 40px;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            /*background: #0f172a;*/
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            cursor: pointer;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

            .scroll-top-btn i {
                font-size: 16px;
            }


            .scroll-top-btn.show {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(0);
            }

        a {
            color: snow;
            text-decoration: none
        }

        .property-card-fav.is-fav {
            background: #ef4444;
        }

            .property-card-fav.is-fav i {
                color: #fff;
            }

        .property-card {
            position: relative; /* để đặt icon heart tuyệt đối */
        }

        .home-search-filter-select {
            padding-left: 7px;
        }

        .property-card {
            position: relative;
        }


        .property-card-fav {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

            .property-card-fav i {
                font-size: 14px;
                color: #fff;
            }

            .property-card-fav:hover {
                transform: scale(1.05);
            }

            .property-card-fav.is-fav {
                background: #ef4444;
            }

                .property-card-fav.is-fav i {
                    color: #fff;
                }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-gap: 24px;
        }

        @@media(min-width:500px) {
            .account-trigger {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                color: #fff;
                padding: 6px 10px;
                border-radius: 999px;
                background: rgba(15, 23, 42, 0.35);
                user-select: none;
            }

                .account-trigger:hover {
                    background: rgba(15, 23, 42, 0.55);
                }
        }
        @@media (max-width: 991px) {
            .property-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .pagination {
            display: flex;
            list-style: none;
            padding-left: 0;
            margin-top: 24px;
            justify-content: center;
        }

            .pagination li {
                margin: 0 4px;
            }

            .pagination a,
            .pagination span {
                display: block;
                padding: 6px 10px;
                border-radius: 4px;
                border: 1px solid #ddd;
                font-size: 14px;
                text-decoration: none;
                color: #333;
                background-color: #fff;
            }

            .pagination .active span {
                background-color: #16a34a;
                border-color: #16a34a;
                color: #fff;
            }

            .pagination .disabled span {
                color: #aaa;
                background-color: #f5f5f5;
            }

        @@media(max-width:500px) {
            .account-dropdown a {
              
                gap: 10px;
                padding: 4px 2px;
                
            }
            .account-dropdown {
                position: absolute;
                top: 68%;
                right: -50px;
                margin-top: 0px;
                min-width: 101px;
                background: rgba(15, 23, 42, 0.95);
                border-radius: 12px;
                 box-shadow: none;
                /* overflow: hidden; */
                opacity: 0;
                transform: translateY(-6px);
                pointer-events: none;
                transition: opacity .15s ease, transform .15s ease;
                z-index: 99999;
            }


            .home-hero-header {
               
                 margin-bottom: 0px; 
            }
            .home-header-right-top {
                /*font-size: clamp(0.9rem, 1.4vw, 1rem);*/
                 margin-bottom: 0rem;
            }
            .account-trigger {
                /* display: inline-flex; */
                /* align-items: center; */
                /* gap: 8px; */
                cursor: pointer;
                color: #fff;
                /* padding: 6px 6px; */
                border-radius: 999px;
                /* background: rgba(15, 23, 42, 0.35); */
                user-select: none;
            }
            .home-hero {
                min-height: 40vh;
                background-size: 100% 40vh;
            }

            .home-search-btn-main {
                width: 30px;
                height: 30px;
            }

            .home-search-input-wrap input {
                font-size: 0.75rem;
            }

            .home-search-tab-btn {
                padding: 6px;
            }

            home-hero-header {
                margin-top: 5px;
            }

            .home-hero-shell {
                width: 97%;
            }
            .home-header-left-box {
                display: flex;
                align-items: center;
                gap: 0.2rem;
            }
            .home-header-right-top a {
               
                 margin: 0 0rem; 
            }
        }
    </style>
</head>

<div class="home-hero" style="background-image:url('@(ViewBag.HeroBackground ?? "/Assets/Banner.jpg")');">
    <div class="home-hero-shell">
        <!-- HEADER -->
        <div class="home-hero-header">
            <!-- Logo + city -->
            <a href=@Url.Action("Index", "Home") class="home-header-left-box">
                <div class="home-logo-icon"></div>
                <div class="home-header-left">
                    <div class="home-header-left-top">
                        <span>NhàNow</span>
                    </div>
                    <div class="home-header-left-tagline">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 2.5C8.96 2.5 6.5 4.96 6.5 8c0 3.74 3.39 7.47 4.96 9.15.29.31.77.31 1.06 0C14.11 15.47 17.5 11.74 17.5 8c0-3.04-2.46-5.5-5.5-5.5zm0 6.5A2 2 0 1 1 12 5a2 2 0 0 1 0 4z" />
                        </svg>
                        @HomeTexts.CityName
                    </div>
                </div>
            </a>

            <!-- Menu phải -->
            <div class="home-header-right-box">
                <div class="home-header-right-top">
                    @if (User.Identity.IsAuthenticated)
                    {
                        var name = Session["CurrentUserName"] as string ?? "Tài khoản";

                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                        </a>

                        <a @*href="#"
                           class="hidden-xs js-fav-top"
                           data-return="@Url.Action("Favorites", "Property")"*@>
                            <i class="fa-solid fa-bell"></i>
                        </a>



                        <!-- Hover vào cụm tài khoản sẽ hiện Logout -->
                        <div class="hidden-xs account-hover">
                            <div class="account-trigger">
                                <i class="fa-solid fa-user"></i>
                                <span>@name</span>
                                <i class="fa-solid fa-caret-down" style="font-size:12px; opacity:.8;"></i>
                            </div>



                            <div class="account-dropdown">
                                <a href="@Url.Action("Logout", "Account")">
                                    <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a href="@Url.Action("Favorites", "Property")"
                           class="hidden-xs js-fav-top"
                           data-return="@Url.Action("Favorites", "Property")">
                            <i class="fa-solid fa-heart"></i>
                        </a>
                        <a @*href="#"
                            class="hidden-xs js-fav-top"
                            data-return="@Url.Action("Favorites", "Property")"*@>
                            <i class="fa-solid fa-bell"></i>
                        </a>
                        <a href="javascript:void(0)" class="hidden-xs js-open-login">Đăng nhập</a>
                    }

                    <a href="@Url.Action("Request", "Landlord")" class="nav-post">
                        @HomeTexts.Menu_Post
                    </a>
                </div>

                <div class="home-header-right-bottom">
                    <a href="@Url.Action("Set", "Language", new { lang = "vi-VN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("vi") ? "lang-active" : "")">
                        VI
                    </a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "en-US", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("en") ? "lang-active" : "")">
                        EN
                    </a>
                    |
                    <a href="@Url.Action("Set", "Language", new { lang = "zh-CN", returnUrl = Request.RawUrl })"
                       class="@(currentLang.StartsWith("zh") ? "lang-active" : "")">
                        中文
                    </a>
                </div>
            </div>
        </div>

        <!-- MAIN + SEARCH -->
        <div class="home-hero-main">
            <div class="home-main-text">
                <div class="home-main-title">
                    @HomeTexts.MainTitle
                </div>
                <div class="home-sub-title">
                    @string.Format(HomeTexts.SubTitle, totalListings)
                </div>
            </div>

            <div class="home-main-search">
                @using (Html.BeginForm("Index", "Home", FormMethod.Get, new { @class = "home-search-form" }))
                {
                    <div class="home-search-wrapper">
                        <!-- HÀNG TRÊN: Thuê/Mua + ô nhập + nút kính lúp -->
                        <div class="home-search-top">
                            <div class="home-search-tabs">
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "rent" ? "active" : "")"
                                        data-value="rent">
                                    Thuê nhà
                                </button>
                                <span style="color:#aaa">|</span>
                                <button type="button"
                                        class="home-search-tab-btn @(currentType == "sale" ? "active" : "")"
                                        data-value="sale">
                                    Mua nhà
                                </button>
                            </div>

                            <div class="home-search-input-wrap">
                                <input type="text"
                                       name="keyword"
                                       value="@Model.Keyword"
                                       placeholder="Nhập vị trí chi tiết: đường, xã, phường..." />
                            </div>

                            <button type="submit" class="home-search-btn-main">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </div>

                        <!-- giữ transactionType -->
                        <input type="hidden"
                               name="transactionType"
                               id="transactionTypeInput"
                               value="@currentType" />

                        <!-- HÀNG DƯỚI: Thành phố / Mốc giá / Loại nhà -->
                        <div class="home-search-bottom">
                            <!-- THÀNH PHỐ -->
                            <div class="home-search-filter">
                                <select id="citySelect" name="cityId" class="home-search-filter-select">
                                    <option value="">Thành phố</option>
                                    @if (Model.Cities != null)
                                    {
                                        foreach (var c in Model.Cities)
                                        {
                                            <option value="@c.CityId"
                                                    data-bg="@c.BackgroundUrl"
                                                    @(Model.CityId == c.CityId ? "selected" : "")>
                                                @c.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- MỐC GIÁ -->
                            <div class="home-search-filter">
                                <select name="priceRange" class="home-search-filter-select">
                                    <option value="">Mốc giá</option>
                                    @if (Model.PriceFilters != null)
                                    {
                                        foreach (var pf in Model.PriceFilters)
                                        {
                                            <option value="@pf.Code"
                                                    @(Model.PriceRange == pf.Code ? "selected" : "")>
                                                @pf.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- LOẠI NHÀ -->
                            <div class="home-search-filter">
                                <select name="propertyType" class="home-search-filter-select">
                                    <option value="">Loại nhà</option>
                                    @if (Model.PropertyTypes != null)
                                    {
                                        foreach (var pt in Model.PropertyTypes)
                                        {
                                            <option value="@pt.Code"
                                                    @(Model.PropertyType == pt.Code ? "selected" : "")>
                                                @pt.Name
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="home-body-container">
    @if (Model.HasSearch)
    {
        <div class="home-section-header">
            <h2>Kết quả tìm kiếm</h2>
        </div>

        if (results.Any())
        {
            <!-- GRID kết quả + dữ liệu cho infinite scroll -->
            <div id="search-results" class="property-grid">
                @Html.Partial("_PropertyCardList", results)
            </div>

            <input type="hidden" id="currentPage" value="@Model.Page" />
            <input type="hidden" id="totalPages" value="@Model.TotalPages" />

            <!-- sentinel để IntersectionObserver canh load thêm -->
            <div id="load-more-sentinel" style="height: 1px;"></div>
        }
        else
        {
            <p>Không tìm thấy căn phù hợp, bạn thử thay đổi điều kiện tìm kiếm nhé.</p>
        }
    }
    else
    {
        <!-- Các căn cho thuê nổi bật -->
        <section style="margin-bottom:24px;">
            <div class="home-section-header">
                <h2>Các căn cho thuê nổi bật</h2>
                <a href="@Url.Action("List", "Property", new { mode = "rent" })">xem thêm</a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredRent)
                {
                    @RenderPropertyCard(item)
                }
            </div>
        </section>

        <!-- Các căn bán nổi bật -->
        <section>
            <div class="home-section-header">
                <h2>Các căn bán nổi bật</h2>
                <a href="@Url.Action("List", "Property", new { mode = "sale" })">xem thêm</a>
            </div>

            <div class="property-grid">
                @foreach (var item in featuredSale)
                {
                    @RenderPropertyCard(item)
                }
            </div>
        </section>
    }
</div>

<!-- Nút lên đầu trang -->
<div href="#" id="scrollTopBtn" class="scroll-top-btn">
    <i class="fa-solid fa-angles-up"></i>
</div>

@section Scripts {
    <script>

        (function () {
            var buttons = document.querySelectorAll(".home-search-tab-btn");
            var hiddenInput = document.getElementById("transactionTypeInput");

            buttons.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var val = this.getAttribute("data-value");
                    hiddenInput.value = val;

                    buttons.forEach(function (b) { b.classList.remove("active"); });
                    this.classList.add("active");
                });
            });
        })();

        // Đổi background theo thành phố
        (function () {
            var hero = document.querySelector(".home-hero");
            var citySelect = document.getElementById("citySelect");
            if (!hero || !citySelect) return;

            function applyCityBackground() {
                var opt = citySelect.options[citySelect.selectedIndex];
                if (!opt) return;

                var bg = opt.getAttribute("data-bg");
                if (bg && bg.length > 0) {
                    hero.style.backgroundImage = "url('" + bg + "')";
                } else {
                    hero.style.backgroundImage = "";
                }
            }

            citySelect.addEventListener("change", applyCityBackground);
            applyCityBackground();
        })();

        // Toggle Favorite (dùng chung cho Home, Favorites, LoadMore append)
        (function () {
            $(document).on('click', '.js-fav-toggle', function (e) {
                e.preventDefault();

                var $btn = $(this);
                var propertyId = $btn.data('id');

                $.ajax({
                    url: '@Url.Action("ToggleFavorite", "Property")',
                    type: 'POST',
                    data: { propertyId: propertyId },
                    success: function (res) {
                        if (!res) return;

                        if (res.needLogin) {
                            if (window.loginModal && typeof window.loginModal.open === 'function') {
                                window.loginModal.open(window.location.pathname + window.location.search);
                            } else {
                                alert('Bạn cần đăng nhập để sử dụng chức năng Yêu thích.');
                            }
                            return;
                        }

                        if (res.success) {
                            if (res.isFavorite) {
                                $btn.addClass('is-fav');
                            } else {
                                $btn.removeClass('is-fav');
                            }
                        }
                    },
                    error: function () {
                        alert('Không thể cập nhật Yêu thích. Vui lòng thử lại.');
                    }
                });
            });
        })();

        // ---------- Infinite Scroll cho kết quả tìm kiếm ----------
        (function () {
            var $results = $('#search-results');
            if ($results.length === 0) return; // không có search thì thôi

            var currentPage = parseInt($('#currentPage').val() || '1', 10);
            var totalPages = parseInt($('#totalPages').val() || '1', 10);
            var isLoading = false;

            var filters = {
                transactionType: '@(Model.TransactionType ?? "")',
                cityId: '@(Model.CityId.HasValue ? Model.CityId.ToString() : "")',
                priceRange: '@(Model.PriceRange ?? "")',
                propertyType: '@(Model.PropertyType ?? "")',
                keyword: '@(Model.Keyword ?? "")'
            };

            function loadNextPage() {
                if (isLoading) return;
                if (currentPage >= totalPages) return;

                isLoading = true;
                currentPage++;

                var data = $.extend({}, filters, { page: currentPage });

                $.get('@Url.Action("LoadMore", "Home")', data)
                    .done(function (html) {
                        if (html && $.trim(html).length > 0) {
                            $results.append(html);

                            // cập nhật currentPage vào hidden để JS khác nếu cần
                            $('#currentPage').val(currentPage);
                        } else {
                            currentPage = totalPages;
                        }
                    })
                    .always(function () {
                        isLoading = false;
                    });
            }

            var sentinel = document.getElementById('load-more-sentinel');

            if ('IntersectionObserver' in window && sentinel) {
                var io = new IntersectionObserver(function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            loadNextPage();
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '0px 0px 200px 0px',
                    threshold: 0
                });

                io.observe(sentinel);
            } else {
                // fallback cho trình duyệt cũ
                $(window).on('scroll', function () {
                    if ($(window).scrollTop() + $(window).height() + 200 >= $(document).height()) {
                        loadNextPage();
                    }
                });
            }
        })();

        // ---------- Nút LÊN ĐẦU TRANG ----------
        (function () {
            var $btn = $('#scrollTopBtn');
            if ($btn.length === 0) return;

            $(window).on('scroll', function () {

                if ($(this).scrollTop() > window.innerHeight) {
                    $btn.addClass('show');
                } else {
                    $btn.removeClass('show');
                }
            });

            $btn.on('click', function (e) {
                e.preventDefault();
                $('html, body').animate({ scrollTop: 0 }, 400);
            });
        })();



  // Giữ dropdown account không tắt ngay khi rê chuột xuống
  (function () {
      var menu = document.querySelector('.account-hover');
      if (!menu) return;

      var timer = null;

      menu.addEventListener('mouseenter', function () {
          if (timer) clearTimeout(timer);
          menu.classList.add('open');
      });

      menu.addEventListener('mouseleave', function () {
          timer = setTimeout(function () {
              menu.classList.remove('open');
          }, 200);
      });
  })();

    // ---------- Favorites trên header: check login giống item ----------
    (function () {
        var isAuth = @User.Identity.IsAuthenticated.ToString().ToLower();

        $(document).on('click', '.js-fav-top', function (e) {
            if (isAuth) return; 

            e.preventDefault();

            var returnUrl = $(this).data('return') || (window.location.pathname + window.location.search);

          
            if (window.loginModal && typeof window.loginModal.open === 'function') {
                window.loginModal.open(returnUrl);
            } else {
                
                window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent(returnUrl);
            }
        });
    })();
    </script>
}
